<!DOCTYPE html>
<html>
<head>

    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Base Meta -->
    <!-- dynamically fixing the title for tag/author pages -->



    <title>Easy Coroutines in Android - viewModelScope</title>

    <!-- This tag outputs SEO meta+structured data and other important settings -->
    <meta name="description" content="A place where you can learn about Android development" />
    <link rel="shortcut icon" href="https://manuelvivo.dev/assets/images/favicon.png" type="image/png" />
    <link rel="canonical" href="https://manuelvivo.dev/viewmodelscope" />
    <meta name="referrer" content="no-referrer-when-downgrade" />

     <!--title below is coming from _includes/dynamic_title-->
    <meta property="og:site_name" content="Manuel Vivo .dev" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Easy Coroutines in Android - viewModelScope" />
    <meta property="og:description" content="Learn everything you should know about viewModelScope Cancelling coroutines when they are no longer needed can be a task easy to forget, it‚Äôs monotonous work and adds a lot of boilerplate code. viewModelScope contributes to structured concurrency by adding an extension property to the ViewModel class that automatically cancels its" />
    <meta property="og:url" content="https://manuelvivo.dev/viewmodelscope" />
    <meta property="og:image" content="https://manuelvivo.dev/assets/images/2019-03-19-viewmodelscope.png" />
    <meta property="article:publisher" content="https://www.facebook.com/" />
    <meta property="article:author" content="https://www.facebook.com/" />
    <meta property="article:published_time" content="2019-03-19T00:00:00+00:00" />
    <meta property="article:modified_time" content="2019-03-19T00:00:00+00:00" />
    <meta property="article:tag" content="Coroutines" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Easy Coroutines in Android - viewModelScope" />
    <meta name="twitter:description" content="Learn everything you should know about viewModelScope Cancelling coroutines when they are no longer needed can be a task easy to forget, it‚Äôs monotonous work and adds a lot of boilerplate code. viewModelScope contributes to structured concurrency by adding an extension property to the ViewModel class that automatically cancels its" />
    <meta name="twitter:url" content="https://manuelvivo.dev/" />
    <meta name="twitter:image" content="https://manuelvivo.dev/assets/images/2019-03-19-viewmodelscope.png" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Manuel Vivo .dev" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Coroutines" />
    <meta name="twitter:site" content="@manuelvicnt" />
    <meta name="twitter:creator" content="@manuelvicnt" />
    <meta property="og:image:width" content="1400" />
    <meta property="og:image:height" content="933" />

    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Website",
    "publisher": {
        "@type": "Organization",
        "name": "Manuel Vivo .dev",
        "logo": "https://manuelvivo.dev/"
    },
    "url": "https://manuelvivo.dev/viewmodelscope",
    "image": {
        "@type": "ImageObject",
        "url": "https://manuelvivo.dev/assets/images/2019-03-19-viewmodelscope.png",
        "width": 2000,
        "height": 666
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://manuelvivo.dev/viewmodelscope"
    },
    "description": "Learn everything you should know about viewModelScope Cancelling coroutines when they are no longer needed can be a task easy to forget, it‚Äôs monotonous work and adds a lot of boilerplate code. viewModelScope contributes to structured concurrency by adding an extension property to the ViewModel class that automatically cancels its"
}
    </script>

<!-- <script type="text/javascript" src="https://demo.ghost.io/public/ghost-sdk.min.js?v=724281a32e"></script>
<script type="text/javascript">
ghost.init({
	clientId: "ghost-frontend",
	clientSecret: "f84a07a72b17"
});
</script> -->

<meta name="generator" content="Jekyll 3.6.2" />
<link rel="alternate" type="application/rss+xml" title="Easy Coroutines in Android - viewModelScope" href="/feed.xml" />

<style>
    .highlighter-rouge, .highlight, code {
        width: 100%;
    }
</style>

<!-- Jekyll Ideal Image Slider Include -->
<!-- https://github.com/jekylltools/jekyll-ideal-image-slider-include -->
<!-- v1.8 -->

    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Easy Coroutines in Android - viewModelScope | Manuel Vivo .dev</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="Easy Coroutines in Android - viewModelScope" />
<meta name="author" content="Manuel Vivo" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Learn everything you should know about viewModelScope" />
<meta property="og:description" content="Learn everything you should know about viewModelScope" />
<link rel="canonical" href="https://manuelvivo.dev/viewmodelscope" />
<meta property="og:url" content="https://manuelvivo.dev/viewmodelscope" />
<meta property="og:site_name" content="Manuel Vivo .dev" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-03-19T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Easy Coroutines in Android - viewModelScope" />
<meta name="twitter:site" content="@" />
<meta name="twitter:creator" content="@manuelvicnt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Manuel Vivo","url":"github.com/manuelvicnt"},"dateModified":"2019-03-19T00:00:00+00:00","datePublished":"2019-03-19T00:00:00+00:00","description":"Learn everything you should know about viewModelScope","headline":"Easy Coroutines in Android - viewModelScope","mainEntityOfPage":{"@type":"WebPage","@id":"https://manuelvivo.dev/viewmodelscope"},"url":"https://manuelvivo.dev/viewmodelscope"}</script>
<!-- End Jekyll SEO tag -->


    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.edited.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/syntax.css" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css?family=Montserrat&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Inter&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro&display=swap" rel="stylesheet">

    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!--[if IE]>
        <style>
            p, ol, ul{
                width: 100%;
            }
            blockquote{
                width: 100%;
            }
        </style>
    <![endif]-->
</head>
<body class="post-template">

    <div class="site-wrapper">
        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left">
        
            
                <a class="site-nav-logo" href="https://manuelvivo.dev/">Manuel Vivo .dev</a>
            
        
        
            <ul class="nav" role="menu">
    <li class="nav-home" role="menuitem"><a href="/">Home</a></li>
    <li class="nav-book" role="menuitem"><a href="https://topmate.io/manuelvivo" target="_blank">üóìÔ∏è Book a 1:1 with me!</a></li>
    <li class="nav-digitalproduct" role="menuitem"><a href="/digitalproduct/">Products</a></li>
    <li class="nav-publicspeaking" role="menuitem"><a href="/publicspeaking/">Public Speaking</a></li>
    <li class="nav-about" role="menuitem"><a href="/about/">About</a></li>
    <li class="nav-gallery" role="menuitem"><a href="/gallery/">Gallery</a></li>
</ul>
        
    </div>
    <div class="site-nav-right">
        <div class="social-links">
            
            
                <a class="social-link social-link-tw" href="https://twitter.com/manuelvicnt" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>
</a>
            
        </div>
        
    </div>
</nav>

    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full  tag-coroutines post ">

            <header class="post-full-header">
              <section class="post-full-meta">
                  <time class="post-full-meta-date" datetime="19 March 2019">19 March 2019</time>
              </section>

              
                  
                    <span class="post-card-tags"><a style="color:white;" href='/tag/coroutines/'>Coroutines</a></span>
                  
              
                <h1 class="post-full-title">Easy Coroutines in Android - viewModelScope</h1>
            </header>

            
            <figure class="post-full-image" style="background-image: url(/assets/images/2019-03-19-viewmodelscope.png)">
            </figure>
            

            <section class="post-full-content">
                <div class="kg-card-markdown">
                    <p>Learn everything you should know about viewModelScope</p>

<p>Cancelling coroutines when they are no longer needed can be a task easy to forget, it‚Äôs monotonous work and adds a lot of boilerplate code. <code class="language-plaintext highlighter-rouge">viewModelScope</code> contributes to <a href="https://kotlinlang.org/docs/reference/coroutines/basics.html#structured-concurrency">structured concurrency</a> by adding an <a href="https://kotlinlang.org/docs/reference/extensions.html#extension-properties">extension property</a> to the ViewModel class that automatically cancels its child coroutines when the ViewModel is destroyed.</p>

<h2 id="scopes-in-viewmodels">Scopes in ViewModels</h2>

<p>A <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-coroutine-scope/"><code class="language-plaintext highlighter-rouge">CoroutineScope</code></a> keeps track of all coroutines it creates. Therefore, if you cancel a scope, you cancel all coroutines it created. This is particularly important if you‚Äôre running coroutines in a <a href="https://developer.android.com/topic/libraries/architecture/viewmodel">ViewModel</a>. If your ViewModel is getting destroyed, all the asynchronous work that it might be doing must be stopped. Otherwise, you‚Äôll waste resources and potentially leaking memory. If you consider that certain asynchronous work should persist after ViewModel destruction, it is because it should be done in a lower layer of your app‚Äôs architecture.</p>

<p>Add a <code class="language-plaintext highlighter-rouge">CoroutineScope</code> to your ViewModel by creating a new scope with a <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-supervisor-job.html"><code class="language-plaintext highlighter-rouge">SupervisorJob</code></a> that you cancel in the <code class="language-plaintext highlighter-rouge">onCleared()</code> method. The coroutines created with that scope will live as long as the ViewModel is being used. See following code:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MyViewModel</span> <span class="p">:</span> <span class="nc">ViewModel</span><span class="p">()</span> <span class="p">{</span>

    <span class="cm">/**
     * This is the job for all coroutines started by this ViewModel.
     * Cancelling this job will cancel all coroutines started by this ViewModel.
     */</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">viewModelJob</span> <span class="p">=</span> <span class="nc">SupervisorJob</span><span class="p">()</span>
    
    <span class="cm">/**
     * This is the main scope for all coroutines launched by MainViewModel.
     * Since we pass viewModelJob, you can cancel all coroutines 
     * launched by uiScope by calling viewModelJob.cancel()
     */</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">uiScope</span> <span class="p">=</span> <span class="nc">CoroutineScope</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">Main</span> <span class="p">+</span> <span class="n">viewModelJob</span><span class="p">)</span>
    
    <span class="cm">/**
     * Cancel all coroutines when the ViewModel is cleared
     */</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCleared</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="nf">onCleared</span><span class="p">()</span>
        <span class="n">viewModelJob</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="cm">/**
     * Heavy operation that cannot be done in the Main Thread
     */</span>
    <span class="k">fun</span> <span class="nf">launchDataLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">uiScope</span><span class="p">.</span><span class="nf">launch</span> <span class="p">{</span>
            <span class="nf">sortList</span><span class="p">()</span> <span class="c1">// happens on the background</span>
            <span class="c1">// Modify UI</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// Move the execution off the main thread using withContext(Dispatchers.Default)</span>
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">sortList</span><span class="p">()</span> <span class="p">=</span> <span class="nf">withContext</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">Default</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Heavy work</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The heavy work happening in the background will be cancelled if the ViewModel gets destroyed because the coroutine was started by that particular <code class="language-plaintext highlighter-rouge">uiScope</code>.</p>

<p>But that‚Äôs a lot of code to be included in every ViewModel, right? <strong><code class="language-plaintext highlighter-rouge">viewModelScope</code></strong> comes to simplify all this.</p>

<h2 id="viewmodelscope-means-less-boilerplate-code">viewModelScope means less boilerplate code</h2>

<p><a href="https://developer.android.com/jetpack/androidx/releases/lifecycle">AndroidX lifecycle v2.1.0</a> introduced the extension property <code class="language-plaintext highlighter-rouge">viewModelScope</code> to the ViewModel class. It manages the coroutines in the same way we were doing in the previous section. That code is cut down to this:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MyViewModel</span> <span class="p">:</span> <span class="nc">ViewModel</span><span class="p">()</span> <span class="p">{</span>
  
    <span class="cm">/**
     * Heavy operation that cannot be done in the Main Thread
     */</span>
    <span class="k">fun</span> <span class="nf">launchDataLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">viewModelScope</span><span class="p">.</span><span class="nf">launch</span> <span class="p">{</span>
            <span class="nf">sortList</span><span class="p">()</span>
            <span class="c1">// Modify UI</span>
        <span class="p">}</span>
    <span class="p">}</span>
  
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">sortList</span><span class="p">()</span> <span class="p">=</span> <span class="nf">withContext</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">Default</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Heavy work</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>All the <code class="language-plaintext highlighter-rouge">CoroutineScope</code> setup and cancellation is done for us. To use it, import the following dependency in your <code class="language-plaintext highlighter-rouge">build.gradle</code> file:</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">implementation</span> <span class="s2">"androidx.lifecycle.lifecycle-viewmodel-ktx$lifecycle_version"</span>
</code></pre></div></div>

<p>Let‚Äôs take a look at what‚Äôs happening under the hood.</p>

<h2 id="digging-into-viewmodelscope">Digging into viewModelScope</h2>

<p>The code is <a href="https://cs.android.com/androidx/platform/frameworks/support/+/androidx-master-dev:lifecycle/lifecycle-viewmodel-ktx/src/main/java/androidx/lifecycle/ViewModel.kt">publicly available</a>. <code class="language-plaintext highlighter-rouge">viewModelScope</code> is implemented as follows:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">const</span> <span class="kd">val</span> <span class="py">JOB_KEY</span> <span class="p">=</span> <span class="s">"androidx.lifecycle.ViewModelCoroutineScope.JOB_KEY"</span>

<span class="kd">val</span> <span class="py">ViewModel</span><span class="p">.</span><span class="n">viewModelScope</span><span class="p">:</span> <span class="nc">CoroutineScope</span>
    <span class="k">get</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">scope</span><span class="p">:</span> <span class="nc">CoroutineScope</span><span class="p">?</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">getTag</span><span class="p">(</span><span class="nc">JOB_KEY</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">scope</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">scope</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nf">setTagIfAbsent</span><span class="p">(</span><span class="nc">JOB_KEY</span><span class="p">,</span>
            <span class="nc">CloseableCoroutineScope</span><span class="p">(</span><span class="nc">SupervisorJob</span><span class="p">()</span> <span class="p">+</span> <span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">Main</span><span class="p">.</span><span class="n">immediate</span><span class="p">))</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>The ViewModel class has a <code class="language-plaintext highlighter-rouge">ConcurrentHashSet</code> attribute where it can store any kind of object. The CoroutineScope is stored there. If we take a look at the code, the method <code class="language-plaintext highlighter-rouge">getTag(JOB_KEY)</code> tries to retrieve the scope from there. If it doesn‚Äôt exist, then it creates a new CoroutineScope the same way we did before and adds the tag to the bag.</p>

<p>When the ViewModel is cleared, it executes the method <code class="language-plaintext highlighter-rouge">clear()</code> before calling the <code class="language-plaintext highlighter-rouge">onCleared()</code> method that we would‚Äôve had to override otherwise. In the <code class="language-plaintext highlighter-rouge">clear()</code> method the ViewModel cancels the <code class="language-plaintext highlighter-rouge">Job</code> of the <code class="language-plaintext highlighter-rouge">viewModelScope</code>. The <a href="https://cs.android.com/androidx/platform/frameworks/support/+/androidx-master-dev:lifecycle/lifecycle-viewmodel/src/main/java/androidx/lifecycle/ViewModel.java">full ViewModel code</a> is also available but we are just focusing on the parts we are interested in:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@MainThread</span>
<span class="kd">final</span> <span class="kt">void</span> <span class="nf">clear</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">mCleared</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="c1">// Since clear() is final, this method is still called on mock </span>
    <span class="c1">// objects and in those cases, mBagOfTags is null. It'll always </span>
    <span class="c1">// be empty though because setTagIfAbsent and getTag are not </span>
    <span class="c1">// final so we can skip clearing it</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mBagOfTags</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Object</span> <span class="n">value</span> <span class="o">:</span> <span class="n">mBagOfTags</span><span class="o">.</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
            <span class="c1">// see comment for the similar call in setTagIfAbsent</span>
            <span class="n">closeWithRuntimeException</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">onCleared</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The method goes through all the items in the bag and calls <code class="language-plaintext highlighter-rouge">closeWithRuntimeException</code> that checks if the object is of type <code class="language-plaintext highlighter-rouge">Closeable</code> and if so, closes it. In order for the ViewModel to close the scope, it needs to implement the <code class="language-plaintext highlighter-rouge">Closeable</code> interface. That‚Äôs why <code class="language-plaintext highlighter-rouge">viewModelScope</code> is of type <code class="language-plaintext highlighter-rouge">CloseableCoroutineScope</code> that extends <code class="language-plaintext highlighter-rouge">CoroutineScope</code> overriding the <code class="language-plaintext highlighter-rouge">coroutineContext</code> and implements the <code class="language-plaintext highlighter-rouge">Closeable</code> interface.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">internal</span> <span class="kd">class</span> <span class="nc">CloseableCoroutineScope</span><span class="p">(</span>
    <span class="n">context</span><span class="p">:</span> <span class="nc">CoroutineContext</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">Closeable</span><span class="p">,</span> <span class="nc">CoroutineScope</span> <span class="p">{</span>
  
    <span class="k">override</span> <span class="kd">val</span> <span class="py">coroutineContext</span><span class="p">:</span> <span class="nc">CoroutineContext</span> <span class="p">=</span> <span class="n">context</span>
  
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">close</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">coroutineContext</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="dispatchersmain-as-default">Dispatchers.Main as default</h2>

<p><code class="language-plaintext highlighter-rouge">Dispatchers.Main.immediate</code> is set as the default <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-coroutine-dispatcher/index.html"><code class="language-plaintext highlighter-rouge">CoroutineDispatcher</code></a> for <code class="language-plaintext highlighter-rouge">viewModelScope</code>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">scope</span> <span class="p">=</span> <span class="nc">CloseableCoroutineScope</span><span class="p">(</span><span class="nc">SupervisorJob</span><span class="p">()</span> <span class="p">+</span> <span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">Main</span><span class="p">.</span><span class="n">immediate</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Dispatchers.Main</code> is a natural fit for this case since ViewModel is a concept related to UI that is often involved in updating it so launching on another dispatcher will introduce at least 2 extra thread switches. Considering that suspend functions will do their own thread confinement properly, going with other Dispatchers wouldn‚Äôt be an option since we‚Äôd be making an assumption of what the ViewModel is doing.</p>

<p><code class="language-plaintext highlighter-rouge">immediate</code> is used to execute the coroutine immediately without needing to re-<a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-coroutine-dispatcher/dispatch.html"><code class="language-plaintext highlighter-rouge">dispatch</code></a> the work to the appropriate thread.</p>

<h2 id="unit-testing-viewmodelscope">Unit Testing viewModelScope</h2>

<p><code class="language-plaintext highlighter-rouge">Dispatchers.Main</code> uses the <code class="language-plaintext highlighter-rouge">Android Looper.getMainLooper()</code> method to run code in the UI thread. That method is available in Instrumented Android tests but not in Unit tests.</p>

<p>Use the <code class="language-plaintext highlighter-rouge">org.jetbrains.kotlinx:kotlinx-coroutines-test:$coroutines_version</code> library to replace the Coroutines Main Dispatcher by calling <code class="language-plaintext highlighter-rouge">Dispatchers.setMain(dispatcher: CoroutineDispatcher)</code> with a <code class="language-plaintext highlighter-rouge">TestCoroutineDispatcher</code> that is available in <code class="language-plaintext highlighter-rouge">org.jetbrains.kotlinx:kotlinx-coroutines-test:$coroutines_version</code>. Note that <code class="language-plaintext highlighter-rouge">Dispatchers.setMain</code> is only needed if you use <code class="language-plaintext highlighter-rouge">viewModelScope</code> or you hardcode <code class="language-plaintext highlighter-rouge">Dispatchers.Main</code> in your codebase.</p>

<p><a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-test/kotlinx.coroutines.test/-test-coroutine-dispatcher/"><code class="language-plaintext highlighter-rouge">TestCoroutineDispatcher</code></a> is a dispatcher that gives us control of how coroutines are executed, being able to pause/resume execution and control its virtual clock. It was added as an experimental API in Kotlin Coroutines v1.2.1. You can read more about it in the <a href="https://github.com/Kotlin/kotlinx.coroutines/tree/master/kotlinx-coroutines-test">documentation</a>.</p>

<p>Don‚Äôt use <code class="language-plaintext highlighter-rouge">Dispatchers.Unconfined</code> as a replacement of Dispatchers.Main, it will break all assumptions and timings for code that does use <code class="language-plaintext highlighter-rouge">Dispatchers.Main</code>. Since a unit test should run well in isolation and without any side effects, you should call <code class="language-plaintext highlighter-rouge">Dispatchers.resetMain()</code> and clean up the executor when the test finishes running.</p>

<p>You can use this JUnitRule with that logic to simplify your code:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@ExperimentalCoroutinesApi</span>
<span class="kd">class</span> <span class="nc">CoroutinesTestRule</span><span class="p">(</span>
        <span class="kd">val</span> <span class="py">testDispatcher</span><span class="p">:</span> <span class="nc">TestCoroutineDispatcher</span> <span class="p">=</span> <span class="nc">TestCoroutineDispatcher</span><span class="p">()</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">TestWatcher</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">starting</span><span class="p">(</span><span class="n">description</span><span class="p">:</span> <span class="nc">Description</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="nf">starting</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
        <span class="nc">Dispatchers</span><span class="p">.</span><span class="nf">setMain</span><span class="p">(</span><span class="n">testDispatcher</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">finished</span><span class="p">(</span><span class="n">description</span><span class="p">:</span> <span class="nc">Description</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="nf">finished</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
        <span class="nc">Dispatchers</span><span class="p">.</span><span class="nf">resetMain</span><span class="p">()</span>
        <span class="n">testDispatcher</span><span class="p">.</span><span class="nf">cleanupTestCoroutines</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now, you can use it in your Unit Tests.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MainViewModelUnitTest</span> <span class="p">{</span>
  
    <span class="err">@</span><span class="k">get</span><span class="p">:</span><span class="nc">Rule</span>
    <span class="kd">var</span> <span class="py">coroutinesTestRule</span> <span class="p">=</span> <span class="nc">CoroutinesTestRule</span><span class="p">()</span>
  
    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">test</span><span class="p">()</span> <span class="p">{</span>
        <span class="cm">/* ... */</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="testing-coroutines-using-mockito">Testing coroutines using Mockito</h3>

<p>Do you use Mockito and want to <code class="language-plaintext highlighter-rouge">verify</code> that interactions with an object happen? Note that using Mockito‚Äôs <code class="language-plaintext highlighter-rouge">verify</code> method is not the preferred way to unit test your code. You should check app-specific logic such as an element is present rather than verifying that interactions with an object happen.</p>

<p>Before checking that the interaction with an object happened, we need to make sure that all coroutines launched have finished. Let‚Äôs take a look at the following example.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MainViewModel</span><span class="p">(</span><span class="k">private</span> <span class="kd">val</span> <span class="py">dependency</span><span class="p">:</span> <span class="nc">Any</span><span class="p">):</span> <span class="nc">ViewModel</span> <span class="p">{</span>
  
  <span class="k">fun</span> <span class="nf">sampleMethod</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">viewModelScope</span><span class="p">.</span><span class="nf">launch</span> <span class="p">{</span>
      <span class="kd">val</span> <span class="py">hashCode</span> <span class="p">=</span> <span class="n">dependency</span><span class="p">.</span><span class="nf">hashCode</span><span class="p">()</span>
      <span class="c1">// TODO: do something with hashCode</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">MainViewModelUnitTest</span> <span class="p">{</span>

  <span class="c1">// Mockito setup goes here</span>
  <span class="cm">/* ... */</span>
  
  <span class="err">@</span><span class="k">get</span><span class="p">:</span><span class="nc">Rule</span>
  <span class="kd">var</span> <span class="py">coroutinesTestRule</span> <span class="p">=</span> <span class="nc">CoroutinesTestRule</span><span class="p">()</span>
  
  <span class="nd">@Test</span>
  <span class="k">fun</span> <span class="nf">test</span><span class="p">()</span> <span class="p">=</span> <span class="n">coroutinesTestRule</span><span class="p">.</span><span class="n">testDispatcher</span><span class="p">.</span><span class="nf">runBlockingTest</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">subject</span> <span class="p">=</span> <span class="nc">MainViewModel</span><span class="p">(</span><span class="n">mockObject</span><span class="p">)</span>
    <span class="n">subject</span><span class="p">.</span><span class="nf">sampleMethod</span><span class="p">()</span>
    <span class="c1">// Checks mockObject called the hashCode method that is expected from the coroutine created in sampleMethod</span>
    <span class="nf">verify</span><span class="p">(</span><span class="n">mockObject</span><span class="p">).</span><span class="nf">hashCode</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In the test, we call the <code class="language-plaintext highlighter-rouge">runBlockingTest</code> method inside the <code class="language-plaintext highlighter-rouge">TestCoroutineDispatcher</code> that the rule creates. Since that Dispatcher overrides <code class="language-plaintext highlighter-rouge">Dispatchers.Main</code>, MainViewModel will run the coroutine on that Dispatcher too. Calling <code class="language-plaintext highlighter-rouge">runBlockingTest</code> will make that coroutine to execute synchronously in the test. Since our <code class="language-plaintext highlighter-rouge">verify</code> Mockito call is inside the <code class="language-plaintext highlighter-rouge">runBlockingTest</code> block, it will be called after the coroutine finishes and the interaction will have happened at that moment.</p>

<p>For another example, check out how we added this kind of Unit tests to the Kotlin Coroutines codelab in the <a href="https://github.com/googlecodelabs/kotlin-coroutines/pull/29">this PR</a>.</p>

<hr />

<p>If you are using architecture components, ViewModel and coroutines, use <code class="language-plaintext highlighter-rouge">viewModelScope</code> to let the framework manage its lifecycle for you. It‚Äôs a no brainer!</p>

<p>The <a href="https://codelabs.developers.google.com/codelabs/kotlin-coroutines">Coroutines codelab</a> has been already updated to use it. Check it out to find out more about Coroutines and how to use them in an Android app.</p>

                </div>
            </section>

            <!-- Email subscribe form at the bottom of the page -->
            

            <footer class="post-full-footer">
                <!-- Everything inside the #author tags pulls data from the author -->
                <!-- #author-->
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                        <section class="author-card">
                            
                                <img class="author-profile-image" src="/assets/images/manuelvicnt.jpg" alt="manuel" />
                            
                            <section class="author-card-content">
                                <h4 class="author-card-name"><a href="/author/manuel">Manuel Vivo</a></h4>
                                
                                    <p>Android Developer Relations @ Google</p>
                                
                            </section>
                        </section>
                        <div class="post-full-footer-right">
                            <a class="author-card-button" href="/author/manuel">Read More</a>
                        </div>
                    
                
                <!-- /author  -->
            </footer>

            <!-- If you use Disqus comments, just uncomment this block.
            The only thing you need to change is "test-apkdzgmqhj" - which
            should be replaced with your own Disqus site-id. -->
            
                <section class="post-full-comments">
                    <div id="disqus_thread"></div>
                    <script>
                        var disqus_config = function () {
                            this.page.url = 'https://manuelvivo.dev/viewmodelscope';
                            this.page.identifier = '/viewmodelscope';
                            this.page.title = 'Easy Coroutines in Android - viewModelScope';
                        };
                        (function() {
                            var d = document, s = d.createElement('script');
                            s.src = 'https://manuelvivo.disqus.com/embed.js';
                            s.setAttribute('data-timestamp', +new Date());
                            (d.head || d.body).appendChild(s);
                        })();
                    </script>
                </section>
            

        </article>

    </div>
</main>

<!-- Links to Previous/Next posts -->
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            
                
                
                
                
                    <article class="read-next-card"
                        
                            style="background-image: url(/assets/images/blog-cover.jpg)"
                        
                    >
                        <header class="read-next-card-header">
                            <small class="read-next-card-header-sitetitle">&mdash; Manuel Vivo .dev &mdash;</small>
                            
                                <h3 class="read-next-card-header-title"><a href="/tag/coroutines/">Coroutines</a></h3>
                            
                        </header>
                        <div class="read-next-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
</div>
                        <div class="read-next-card-content">
                            <ul>
                                
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/kotlin-flows-in-practice">Kotlin Flows in practice</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/repeatonlifecycle">repeatOnLifecycle API design story</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/coroutinescope-hilt">Create an application CoroutineScope using Hilt</a></li>
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                  
                                
                            </ul>
                        </div>
                        <footer class="read-next-card-footer">
                            <a href="/tag/coroutines/">
                                
                                    See all 18 posts  ‚Üí
                                
                            </a>
                        </footer>
                    </article>
                
            

            <!-- If there's a next post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/suspend-modifier">
                <div class="post-card-image" style="background-image: url(/assets/images/2019-03-24-suspend-modifier.webp)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/suspend-modifier">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Coroutines</span>
                            
                        
                    

                    <h2 class="post-card-title">The suspend modifier ‚Äî under the hood</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p></p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                        
                        <img class="author-profile-image" src="/assets/images/manuelvicnt.jpg" alt="Manuel Vivo" />
                        
                        <span class="post-card-author">
                            <a href="/author/manuel/">Manuel Vivo</a>
                        </span>
                    
                
                <span class="reading-time">
                    
                    
                      1 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

            <!-- If there's a previous post, display it using the same markup included from - partials/post-card.hbs -->
            

        </div>
    </div>
</aside>

<!-- Floating header which appears on-scroll, included from includes/floating-header.hbs -->
<div class="floating-header">
    <div class="floating-header-logo">
        <a href="https://manuelvivo.dev/">
            
            <span>Manuel Vivo .dev</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">Easy Coroutines in Android - viewModelScope</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=Easy+Coroutines+in+Android+-+viewModelScope&amp;url=https://manuelvivo.dev/viewmodelscope"
            onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https://manuelvivo.dev/viewmodelscope"
            onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>

        </a>
    </div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>


<!-- /post -->

<!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs -->


        <!-- Previous/next page links - displayed on every page -->
        

        <!-- The footer at the very bottom of the screen -->
        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="https://manuelvivo.dev/">Manuel Vivo .dev</a> &copy; 2025</section>
                <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> &
                    <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a> using
                    <a href="https://github.com/jekyller/jasper2" target="_blank" rel="noopener">Jasper2</a></section>
                <nav class="site-footer-nav">
                    <a href="/">Latest Posts</a>
                    
                    <a href="https://twitter.com/manuelvicnt" target="_blank" rel="noopener">Twitter</a>
                    <a href="https://ghost.org" target="_blank" rel="noopener">Ghost</a>
                </nav>
            </div>
        </footer>

    </div>

    <!-- The big email subscribe modal content -->
    

    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.10.0/components/prism-abap.min.js"></script>
    <script>$(document).ready(function() {
      $('pre code').each(function(i, block) {
        hljs.highlightBlock(block);
      });
    });</script>

    <!-- jQuery + Fitvids, which makes all video embeds responsive -->
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://demo.ghost.io/assets/js/jquery.fitvids.js?v=724281a32e"></script>


    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->

    


    <!-- Add Google Analytics  -->
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8WG7TD0NF4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8WG7TD0NF4');
</script>


    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
    
        <script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>

    

    <!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag -->
    <!-- ghost_foot -->

    <!-- Jekyll Ideal Image Slider Include -->
<!-- https://github.com/jekylltools/jekyll-ideal-image-slider-include -->
<!-- v1.8 -->

</body>
</html>

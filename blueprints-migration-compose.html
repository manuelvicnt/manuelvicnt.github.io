<!DOCTYPE html>
<html>
<head>

    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Base Meta -->
    <!-- dynamically fixing the title for tag/author pages -->



    <title>Migrating Architecture Blueprints to Jetpack Compose</title>

    <!-- This tag outputs SEO meta+structured data and other important settings -->
    <meta name="description" content="A place where you can learn about Android development" />
    <link rel="shortcut icon" href="https://manuelvivo.dev/assets/images/favicon.png" type="image/png" />
    <link rel="canonical" href="https://manuelvivo.dev/blueprints-migration-compose" />
    <meta name="referrer" content="no-referrer-when-downgrade" />

     <!--title below is coming from _includes/dynamic_title-->
    <meta property="og:site_name" content="Manuel Vivo .dev" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Migrating Architecture Blueprints to Jetpack Compose" />
    <meta property="og:description" content="This blog post tells the story of how the team migrated Architecture Blueprints to Jetpack Compose. As part of our effort to modernize the app architecture guidance, we want to experiment with different UI patterns to see what works best, find similarities and differences between the alternatives, and ultimately consolidate" />
    <meta property="og:url" content="https://manuelvivo.dev/blueprints-migration-compose" />
    <meta property="og:image" content="https://manuelvivo.dev/assets/images/2022-04-11-blueprints-migration-compose.jpeg" />
    <meta property="article:publisher" content="https://www.facebook.com/" />
    <meta property="article:author" content="https://www.facebook.com/" />
    <meta property="article:published_time" content="2022-04-11T00:00:00+00:00" />
    <meta property="article:modified_time" content="2022-04-11T00:00:00+00:00" />
    <meta property="article:tag" content="Architecture" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Migrating Architecture Blueprints to Jetpack Compose" />
    <meta name="twitter:description" content="This blog post tells the story of how the team migrated Architecture Blueprints to Jetpack Compose. As part of our effort to modernize the app architecture guidance, we want to experiment with different UI patterns to see what works best, find similarities and differences between the alternatives, and ultimately consolidate" />
    <meta name="twitter:url" content="https://manuelvivo.dev/" />
    <meta name="twitter:image" content="https://manuelvivo.dev/assets/images/2022-04-11-blueprints-migration-compose.jpeg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Manuel Vivo .dev" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Architecture" />
    <meta name="twitter:site" content="@manuelvicnt" />
    <meta name="twitter:creator" content="@manuelvicnt" />
    <meta property="og:image:width" content="1400" />
    <meta property="og:image:height" content="933" />

    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Website",
    "publisher": {
        "@type": "Organization",
        "name": "Manuel Vivo .dev",
        "logo": "https://manuelvivo.dev/"
    },
    "url": "https://manuelvivo.dev/blueprints-migration-compose",
    "image": {
        "@type": "ImageObject",
        "url": "https://manuelvivo.dev/assets/images/2022-04-11-blueprints-migration-compose.jpeg",
        "width": 2000,
        "height": 666
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://manuelvivo.dev/blueprints-migration-compose"
    },
    "description": "This blog post tells the story of how the team migrated Architecture Blueprints to Jetpack Compose. As part of our effort to modernize the app architecture guidance, we want to experiment with different UI patterns to see what works best, find similarities and differences between the alternatives, and ultimately consolidate"
}
    </script>

<!-- <script type="text/javascript" src="https://demo.ghost.io/public/ghost-sdk.min.js?v=724281a32e"></script>
<script type="text/javascript">
ghost.init({
	clientId: "ghost-frontend",
	clientSecret: "f84a07a72b17"
});
</script> -->

<meta name="generator" content="Jekyll 3.6.2" />
<link rel="alternate" type="application/rss+xml" title="Migrating Architecture Blueprints to Jetpack Compose" href="/feed.xml" />

<style>
    .highlighter-rouge, .highlight, code {
        width: 100%;
    }
</style>

<!-- Jekyll Ideal Image Slider Include -->
<!-- https://github.com/jekylltools/jekyll-ideal-image-slider-include -->
<!-- v1.8 -->

    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Migrating Architecture Blueprints to Jetpack Compose | Manuel Vivo .dev</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="Migrating Architecture Blueprints to Jetpack Compose" />
<meta name="author" content="Manuel Vivo" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This blog post tells the story of how the team migrated Architecture Blueprints to Jetpack Compose." />
<meta property="og:description" content="This blog post tells the story of how the team migrated Architecture Blueprints to Jetpack Compose." />
<link rel="canonical" href="https://manuelvivo.dev/blueprints-migration-compose" />
<meta property="og:url" content="https://manuelvivo.dev/blueprints-migration-compose" />
<meta property="og:site_name" content="Manuel Vivo .dev" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-04-11T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Migrating Architecture Blueprints to Jetpack Compose" />
<meta name="twitter:site" content="@" />
<meta name="twitter:creator" content="@manuelvicnt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Manuel Vivo","url":"github.com/manuelvicnt"},"dateModified":"2022-04-11T00:00:00+00:00","datePublished":"2022-04-11T00:00:00+00:00","description":"This blog post tells the story of how the team migrated Architecture Blueprints to Jetpack Compose.","headline":"Migrating Architecture Blueprints to Jetpack Compose","mainEntityOfPage":{"@type":"WebPage","@id":"https://manuelvivo.dev/blueprints-migration-compose"},"url":"https://manuelvivo.dev/blueprints-migration-compose"}</script>
<!-- End Jekyll SEO tag -->


    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.edited.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/syntax.css" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css?family=Montserrat&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Inter&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro&display=swap" rel="stylesheet">

    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!--[if IE]>
        <style>
            p, ol, ul{
                width: 100%;
            }
            blockquote{
                width: 100%;
            }
        </style>
    <![endif]-->
</head>
<body class="post-template">

    <div class="site-wrapper">
        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left">
        
            
                <a class="site-nav-logo" href="https://manuelvivo.dev/">Manuel Vivo .dev</a>
            
        
        
            <ul class="nav" role="menu">
    <li class="nav-home" role="menuitem"><a href="/">Home</a></li>
    <li class="nav-book" role="menuitem"><a href="https://topmate.io/manuelvivo" target="_blank">üóìÔ∏è Book a 1:1 with me!</a></li>
    <li class="nav-digitalproduct" role="menuitem"><a href="/digitalproduct/">Products</a></li>
    <li class="nav-publicspeaking" role="menuitem"><a href="/publicspeaking/">Public Speaking</a></li>
    <li class="nav-about" role="menuitem"><a href="/about/">About</a></li>
    <li class="nav-gallery" role="menuitem"><a href="/gallery/">Gallery</a></li>
</ul>
        
    </div>
    <div class="site-nav-right">
        <div class="social-links">
            
            
                <a class="social-link social-link-tw" href="https://twitter.com/manuelvicnt" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>
</a>
            
        </div>
        
    </div>
</nav>

    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full  tag-architecture tag-compose post ">

            <header class="post-full-header">
              <section class="post-full-meta">
                  <time class="post-full-meta-date" datetime="11 April 2022">11 April 2022</time>
              </section>

              
                  
                    <span class="post-card-tags"><a style="color:white;" href='/tag/architecture/'>Architecture</a></span>
                  
                    <span class="post-card-tags"><a style="color:white;" href='/tag/compose/'>Compose</a></span>
                  
              
                <h1 class="post-full-title">Migrating Architecture Blueprints to Jetpack Compose</h1>
            </header>

            
            <figure class="post-full-image" style="background-image: url(/assets/images/2022-04-11-blueprints-migration-compose.jpeg)">
            </figure>
            

            <section class="post-full-content">
                <div class="kg-card-markdown">
                    <p>This blog post tells the story of how the team migrated Architecture Blueprints to Jetpack Compose.</p>

<p>As part of our effort to modernize the <a href="http://goo.gle/mad-architecture-guide">app architecture guidance</a>, we want to experiment with different UI patterns to see what works best, find similarities and differences between the alternatives, and ultimately consolidate those learnings as best practices.</p>

<p>To make our findings as easy to follow as possible, we needed a sample that has a familiar business case and isn‚Äôt too complicated. And‚Ä¶ who doesn‚Äôt know about <em>TODO</em> apps? We chose <a href="https://github.com/android/architecture-samples">Architecture Blueprints</a>! Historically, Blueprints served as an experimental playground for architecture choices. What a great fit for this as well!</p>

<p align="center">
  <img src="assets/images/2022-04-11-blueprints-migration-compose-1.gif" />
  <small>Architecture Blueprints app in action</small>
</p>

<p>The patterns we want to experiment with are obviously affected by the different APIs available nowadays. The new kids in town are <a href="https://developer.android.com/jetpack/compose/state">Jetpack Compose‚Äôs State APIs</a>! As Compose seamlessly works with any <a href="https://developer.android.com/jetpack/guide/ui-layer#udf"><em>Unidirectional Data Flow</em> pattern</a>, we‚Äôll use Compose to render UI to make a fair comparison.</p>

<p><strong>This blog post tells the story of how the team migrated Architecture Blueprints to Jetpack Compose</strong>. As <a href="https://developer.android.com/topic/libraries/architecture/livedata">LiveData</a> is also considered an alternative in our experiments, we left the sample as it was at the time of the migration. <strong>In this refactoring, the ViewModel classes and the data layer were left untouched.</strong></p>

<p>‚ö†Ô∏è The architecture used in this LiveData-based codebase doesn‚Äôt fully follow the <a href="http://goo.gle/mad-architecture-guide">latest architecture best practices</a>. In particular, LiveData <strong>shouldn‚Äôt</strong> be used in the <a href="https://developer.android.com/jetpack/guide/data-layer">data</a> or <a href="https://developer.android.com/jetpack/guide/domain-layer">domain</a> layers ‚Äî Flows and coroutines should be used instead.</p>

<p>Now that the context is clear, let‚Äôs dive in on how we approached refactoring Blueprints to Jetpack Compose. You can check out the full code on the <a href="https://github.com/android/architecture-samples"><code class="language-plaintext highlighter-rouge">main</code> branch</a>.</p>

<h2 id="Ô∏è-planning-a-gradual-migration">‚úçÔ∏è Planning a gradual migration</h2>

<p>Before doing any <em>actual</em> coding work, the team created a migration plan to make sure everyone was on board with the proposed changes. The ultimate goal was to have Blueprints as a single-activity application with screens as composable functions, and using the recommended <a href="https://developer.android.com/jetpack/compose/navigation">Compose Navigation</a> library to move between screens.</p>

<p>Luckily, Blueprints was already a single-activity app that used <a href="https://developer.android.com/guide/navigation">Jetpack Navigation</a> to move between different screens implemented with Fragments. To migrate to Compose, we followed the <a href="https://developer.android.com/jetpack/compose/navigation#interoperability">Navigation interoperability guidance</a> that recommends hybrid apps to use the fragment-based Navigation component and use fragments to hold view-based screens, Compose screens, and screens that use both views and Compose. Unfortunately, it‚Äôs not possible to mix Fragment and Compose destinations in the same Navigation graph.</p>

<p>The goal of a gradual migration is to ease code reviews and maintain a shippable product throughout the migration. The migration plan involved three steps:</p>

<ol>
  <li>
    <p>Migrate the content of each screen to Compose. Each screen could be individually migrated to Compose, including their UI tests. Fragments then become the container/host of each migrated screen.</p>
  </li>
  <li>
    <p>Migrate the app to Navigation Compose ‚Äî which removes all Fragments from the project ‚Äî and migrate the Activity UI logic to root composables. End-to-end tests are also migrated at this point.</p>
  </li>
  <li>
    <p>Remove View system dependencies.</p>
  </li>
</ol>

<p>And that‚Äôs what we did! üßë‚Äçüíª Fast-forward ‚è© two weeks, we migrated the <em>Statistics</em> screen (<a href="https://github.com/android/architecture-samples/pull/821">PR</a>), <em>Add/Edit task</em> screen (<a href="https://github.com/android/architecture-samples/pull/823">PR</a>), <em>Task detail</em> screen (<a href="https://github.com/android/architecture-samples/pull/822">PR</a>), and the <em>Tasks</em> screen (<a href="https://github.com/android/architecture-samples/pull/826">PR</a>); and we merged the <a href="https://github.com/android/architecture-samples/pull/827">final PR</a> which migrated Navigation and Activity logic to Compose, including <a href="https://github.com/android/architecture-samples/pull/827/commits/2810a37c479ef4b23b4cabf095c55df7b342235e">removing unused View system dependencies</a>.</p>

<p align="center">
  <img width="800" src="assets/images/2022-04-11-blueprints-migration-compose-2.png" />
  <small>How we gradually migrated Blueprints to Compose</small>
</p>

<h2 id="-migration-highlights">üí° Migration highlights</h2>

<p>During the migration, we encountered some Compose-specific quirks worth highlighting:</p>

<h3 id="-ui-tests">üß™ UI tests</h3>

<p>Once you start adding Compose to your app, tests that assert Compose UI need to use <a href="https://developer.android.com/jetpack/compose/testing">Compose testing APIs</a>.</p>

<p><strong>For screen-level UI tests</strong>, instead of using the <a href="https://developer.android.com/guide/fragments/test#create"><code class="language-plaintext highlighter-rouge">launchFragmentInContainer&lt;FragmentType&gt;</code></a> API, we used the <code class="language-plaintext highlighter-rouge">createAndroidComposeRule&lt;ComponentActivity&gt;</code> API that allows us to grab string resources in tests. <strong>These tests run in both Espresso and Robolectric</strong>. Because Compose already supports all of this, no extra changes were required. For example, you can compare the code in <a href="https://github.com/android/architecture-samples/blob/653a563e9fe0874b4ae3fba539ce4b6518a2f796/app/src/sharedTest/java/com/example/android/architecture/blueprints/todoapp/addedittask/AddEditTaskFragmentTest.kt"><code class="language-plaintext highlighter-rouge">AddEditTaskFragmentTest</code></a> that was migrated to <a href="https://github.com/manuelvicnt/architecture-samples/blob/8a203594541b25e5eec2daac63415c05884242ad/app/src/sharedTest/java/com/example/android/architecture/blueprints/todoapp/addedittask/AddEditTaskScreenTest.kt"><code class="language-plaintext highlighter-rouge">AddEditTaskScreenTest</code></a>. Note that if you use <code class="language-plaintext highlighter-rouge">ComponentActivity</code>, you need to depend on the <a href="https://developer.android.com/jetpack/compose/testing#setup"><code class="language-plaintext highlighter-rouge">androidx.compose.ui:ui-test-manifest</code></a> artifact.</p>

<p><strong>For end-to-end or integration tests</strong>, we didn‚Äôt find any problems either! Thanks to the <strong>Espresso and Compose interoperability</strong>, we use Espresso assertions to check Views, and Compose APIs to check Compose UI. Here‚Äôs how the <a href="https://github.com/manuelvicnt/architecture-samples/blob/249a636ea9a3f16aab5c284e3245069ef56a557f/app/src/androidTestMock/java/com/example/android/architecture/blueprints/todoapp/tasks/AppNavigationTest.kt"><code class="language-plaintext highlighter-rouge">AppNavigationTest</code></a> looked at one point during the migration to Compose.</p>

<h3 id="-viewmodel-events">ü§ô ViewModel events</h3>

<p>We did have problems with the way <a href="https://developer.android.com/jetpack/guide/ui-layer/events#handle-viewmodel-events">ViewModel events</a> were handled in Blueprints. Blueprints implemented an <a href="https://github.com/android/architecture-samples/blob/8e1e0527a0d043b41da58925a39fb8e03d62829a/app/src/main/java/com/example/android/architecture/blueprints/todoapp/Event.kt">Event wrapper</a> solution to send commands from the ViewModel to the UI. However, that‚Äôs not something that works nicely in Compose. Our recent guidance <a href="https://developer.android.com/jetpack/guide/ui-layer/events#handle-viewmodel-events">recommends</a> modeling those ‚Äúevents‚Äù as state, and that‚Äôs what we did during the migration.</p>

<p>Looking at the <em>showing messages on the screen</em> event use case, we replaced the <code class="language-plaintext highlighter-rouge">Event&lt;Int&gt;</code> type of the LiveData to <code class="language-plaintext highlighter-rouge">Int?</code> This also models the scenario where there is no message to show to the user. In this particular use case, the ViewModel also requires a confirmation from the UI whenever the message has been displayed. See the diff between both implementations in the following code:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Copyright 2022 Google LLC. 
   SPDX-License-Identifier: Apache-2.0 */</span>

<span class="kd">class</span> <span class="nc">AddEditTaskViewModel</span><span class="p">(</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">tasksRepository</span><span class="p">:</span> <span class="nc">TasksRepository</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">ViewModel</span><span class="p">()</span> <span class="p">{</span>

<span class="p">-</span>  <span class="k">private</span> <span class="kd">val</span> <span class="py">_snackbarText</span> <span class="p">=</span> <span class="nc">MutableLiveData</span><span class="p">&lt;</span><span class="nc">Event</span><span class="p">&lt;</span><span class="nc">Int</span><span class="p">&gt;&gt;()</span>
<span class="p">-</span>  <span class="kd">val</span> <span class="py">snackbarText</span><span class="p">:</span> <span class="nc">LiveData</span><span class="p">&lt;</span><span class="nc">Event</span><span class="p">&lt;</span><span class="nc">Int</span><span class="p">&gt;&gt;</span> <span class="p">=</span> <span class="n">_snackbarText</span>

<span class="p">+</span>  <span class="k">private</span> <span class="kd">val</span> <span class="py">_snackbarText</span> <span class="p">=</span> <span class="nc">MutableLiveData</span><span class="p">&lt;</span><span class="nc">Int</span><span class="err">?</span><span class="p">&gt;()</span>
<span class="p">+</span>  <span class="kd">val</span> <span class="py">snackbarText</span><span class="p">:</span> <span class="nc">LiveData</span><span class="p">&lt;</span><span class="nc">Int</span><span class="err">?</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">_snackbarText</span>

<span class="p">+</span>  <span class="k">fun</span> <span class="nf">snackbarMessageShown</span><span class="p">()</span> <span class="p">{</span>
<span class="p">+</span>    <span class="n">_snackbarText</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="k">null</span>
<span class="p">+</span>  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Even though this might seem like more work at first glance, it <strong>guarantees</strong> that the message is displayed on the screen!</p>

<p>In the UI code, the way to make sure the event is handled only once is by calling <code class="language-plaintext highlighter-rouge">event.getContentIfNotHandled()</code>. This approach works <em>okayish</em> in Fragments but <strong>it completely breaks in Compose</strong> when you are writing natural Compose code! Because recompositions can happen at any time in Compose, the event wrapper is not a valid solution. If the event is processed and the function gets recomposed (something that happened very regularly while testing this approach), then the snackbar will be canceled, and the user might miss the message. That‚Äôs an unacceptable UX issue! <strong>The event wrapper solution shouldn‚Äôt be used in Compose apps</strong>.</p>

<p>Note that you can come up with Compose code that avoids recomposing parts of the function in certain scenarios, however, the event wrapper solution is limiting how the UI must be implemented in that case. <strong>Using the event wrapper solution in Compose is discouraged</strong>.</p>

<p>See the following code snippet with the <em>before</em> (event wrapper) and <em>after</em> (event as state) code. Because showing messages on the screen is <a href="https://developer.android.com/jetpack/guide/ui-layer#logic-types">UI logic</a> and our screen composables were getting complex, we used a <a href="https://developer.android.com/jetpack/compose/state#types-of-state-and-logic">plain state holder class</a> to manage that complexity (e.g. see <a href="https://github.com/manuelvicnt/architecture-samples/blob/88cf650fd1759486cce198878b5cf08e823012dc/app/src/main/java/com/example/android/architecture/blueprints/todoapp/addedittask/AddEditTaskState.kt"><code class="language-plaintext highlighter-rouge">AddEditTaskState</code></a>).</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Copyright 2022 Google LLC. 
   SPDX-License-Identifier: Apache-2.0 */</span>

<span class="c1">// FRAGMENTS CODE CONSUMING THE EVENT WRAPPER SOLUTION</span>

<span class="p">-</span> <span class="kd">class</span> <span class="nc">AddEditTaskFragment</span> <span class="p">:</span> <span class="nc">Fragment</span><span class="p">()</span> <span class="p">{</span>
<span class="p">-</span>   <span class="k">override</span> <span class="k">fun</span> <span class="nf">onViewCreated</span><span class="p">(</span><span class="n">view</span><span class="p">:</span> <span class="nc">View</span><span class="p">,</span> <span class="n">savedInstanceState</span><span class="p">:</span> <span class="nc">Bundle</span><span class="p">?)</span> <span class="p">{</span>
<span class="p">-</span>     <span class="o">..</span><span class="p">.</span>
<span class="p">-</span>     <span class="n">viewModel</span><span class="p">.</span><span class="n">snackbarText</span><span class="p">.</span><span class="nf">observe</span><span class="p">(</span>
<span class="p">-</span>       <span class="n">lifecycleOwner</span><span class="p">,</span>
<span class="p">-</span>       <span class="nc">Observer</span> <span class="p">{</span> <span class="n">event</span> <span class="p">-&gt;</span>
<span class="p">-</span>         <span class="n">event</span><span class="p">.</span><span class="nf">getContentIfNotHandled</span><span class="p">()</span><span class="o">?.</span><span class="nf">let</span> <span class="p">{</span>
<span class="p">-</span>           <span class="nf">showSnackbar</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="nf">getString</span><span class="p">(</span><span class="n">it</span><span class="p">),</span> <span class="nc">Snackbar</span><span class="p">.</span><span class="nc">LENGTH_SHORT</span><span class="p">)</span>
<span class="p">-</span>         <span class="p">}</span>
<span class="p">-</span>       <span class="p">}</span>
<span class="p">-</span>     <span class="p">)</span>
<span class="p">-</span>   <span class="p">}</span>
<span class="p">-</span> <span class="p">}</span>


<span class="c1">// COMPOSE CODE CONSUMING USER MESSAGES AS STATE</span>

<span class="c1">// State holder for the AddEditTask composable.</span>
<span class="c1">// This class handles AddEditTask's UI elements' state and UI logic.</span>
<span class="p">+</span> <span class="kd">class</span> <span class="nc">AddEditTaskState</span><span class="p">(</span><span class="o">..</span><span class="p">.)</span> <span class="p">{</span>
<span class="p">+</span>   <span class="nf">init</span> <span class="p">{</span>
<span class="p">+</span>     <span class="c1">// Listen for snackbar messages</span>
<span class="p">+</span>     <span class="n">viewModel</span><span class="p">.</span><span class="n">snackbarText</span><span class="p">.</span><span class="nf">observe</span><span class="p">(</span><span class="n">viewLifecycleOwner</span><span class="p">)</span> <span class="p">{</span> <span class="n">snackbarMessage</span> <span class="p">-&gt;</span>
<span class="p">+</span>       <span class="k">if</span> <span class="p">(</span><span class="n">snackbarMessage</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
<span class="p">+</span>       <span class="c1">// If there's a previous message showing on the screen</span>
<span class="p">+</span>       <span class="c1">// stop showing it in favor of the new one to be displayed</span>
<span class="p">+</span>       <span class="n">currentSnackbarJob</span><span class="o">?.</span><span class="nf">cancel</span><span class="p">()</span>
<span class="p">+</span>       <span class="kd">val</span> <span class="py">snackbarText</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="nf">getString</span><span class="p">(</span><span class="n">snackbarMessage</span><span class="p">)</span>
<span class="p">+</span>       <span class="n">currentSnackbarJob</span> <span class="p">=</span> <span class="n">coroutineScope</span><span class="p">.</span><span class="nf">launch</span> <span class="p">{</span>
<span class="p">+</span>         <span class="n">scaffoldState</span><span class="p">.</span><span class="n">snackbarHostState</span><span class="p">.</span><span class="nf">showSnackbar</span><span class="p">(</span><span class="n">snackbarText</span><span class="p">)</span>
<span class="p">+</span>         <span class="n">viewModel</span><span class="p">.</span><span class="nf">snackbarMessageShown</span><span class="p">()</span>
<span class="p">+</span>       <span class="p">}</span>
<span class="p">+</span>     <span class="p">}</span>
<span class="p">+</span>   <span class="p">}</span>
<span class="p">+</span> <span class="p">}</span>
</code></pre></div></div>

<h3 id="-when-in-doubt-choose-app-correctness">üëå When in doubt, choose app correctness</h3>

<p>While refactoring, it might be tempting to migrate <em>everything</em> at hand to Compose. While that‚Äôs totally fine, you shouldn‚Äôt sacrifice your app‚Äôs User Experience or correctness. The whole point of doing a gradual migration is that the app is always in a shippable state.</p>

<p>This happened to us while migrating some screens to Compose. We didn‚Äôt want to do too many migrations at the same time, and migrated some of the screens to Compose <em>before</em> migrating from the Event wrapper. Instead of handling the Event wrapper in Compose and providing a suboptimal experience, we kept handling those messages in the Fragment while the rest of the code for the screen was in Compose. See, for example, the state of the <a href="https://github.com/manuelvicnt/architecture-samples/blob/249a636ea9a3f16aab5c284e3245069ef56a557f/app/src/main/java/com/example/android/architecture/blueprints/todoapp/tasks/TasksFragment.kt"><code class="language-plaintext highlighter-rouge">TasksFragment</code> during the migration</a>.</p>

<h2 id="-challenges">üßê Challenges</h2>

<p>Not everything went as smoothly as it might have seemed. Even though converting Fragment content to Compose is straightforward, migrating from Navigation Fragments to Navigation Compose took a bit more time and consideration.</p>

<p>There‚Äôs a need to expand and improve the guidance on different aspects that will make migrating to Compose easier in the future. This work sparked conversations and we hope to have new guidance on this soon! üéä</p>

<p>As a Navigation beginner ‚úã and the person that handled the migration to Navigation Compose, I faced the following challenges:</p>

<ul>
  <li>
    <p>No code in the docs showed how to <strong>navigate with optional arguments</strong>! Thanks to <a href="https://github.com/chrisbanes/tivi/blob/main/app/src/main/java/app/tivi/AppNavigation.kt">Tivi‚Äôs navigation graph</a>, I found my way and solved the issue (follow the issue to improve the docs <a href="https://issuetracker.google.com/226103829">here</a>).</p>
  </li>
  <li>
    <p><strong>Migrating from a XML-based Navigation graph and SafeArgs to Kotlin DSL</strong> should be a straightforward, mechanical task. However, it wasn‚Äôt <em>that</em> easy for me considering I didn‚Äôt work on the original implementation. Some guidance about how to do it properly would‚Äôve helped me (follow the issue to improve the docs <a href="https://issuetracker.google.com/226315955">here</a>).</p>
  </li>
  <li>
    <p>More than a challenge, this point is a gotcha! <strong><a href="https://developer.android.com/guide/navigation/navigation-ui">Navigation UI</a> does some work for you already</strong> when it comes to navigating. As this is not available in Compose, you need to keep an eye on that and do it manually. For example, keeping the backstack clean when navigating between Drawer‚Äôs screens requires special <code class="language-plaintext highlighter-rouge">NavigationOptions</code> (see example <a href="https://github.com/android/architecture-samples/blob/dev-compose/app/src/main/java/com/example/android/architecture/blueprints/todoapp/TodoNavigation.kt#L79">here</a>). This is already <a href="https://developer.android.com/jetpack/compose/navigation#bottom-nav">covered in the docs</a>, but you need to be aware that you need it!</p>
  </li>
</ul>

<h2 id="-conclusions">üßë‚Äçüè´ Conclusions</h2>

<p>Overall, migrating from Navigation Fragments to Navigation Compose was a fun task to do! Funnily enough, we spent more time waiting for peer reviews than migrating the project itself! Creating the migration plan and getting everyone on the same page definitely helped to set expectations early and alert peers of lengthy incoming reviews.</p>

<p>We hope you enjoyed reading about our approach to migrating to Compose, and we‚Äôre looking forward to sharing more about the experiments and improvements we‚Äôll be doing in Architecture Blueprints.</p>

<p>If you‚Äôre interested in seeing Blueprints with Compose code, take a look at the <a href="https://github.com/android/architecture-samples/tree/dev-compose"><code class="language-plaintext highlighter-rouge">dev-compose</code> branch</a>. And in case you want to go through the PRs of the gradual migration, here‚Äôs the list:</p>

<ul>
  <li><em>Statistics</em> screen (<a href="https://github.com/android/architecture-samples/pull/821">PR</a>),</li>
  <li><em>Add/Edit task</em> screen (<a href="https://github.com/android/architecture-samples/pull/823">PR</a>),</li>
  <li><em>Task detail</em> screen (<a href="https://github.com/android/architecture-samples/pull/822">PR</a>),</li>
  <li><em>Tasks</em> screen (<a href="https://github.com/android/architecture-samples/pull/826">PR</a>); and</li>
  <li>the <a href="https://github.com/android/architecture-samples/pull/827">final PR</a> which migrated Navigation and Activity logic to Compose, including <a href="https://github.com/android/architecture-samples/pull/827/commits/2810a37c479ef4b23b4cabf095c55df7b342235e">removing unused View system dependencies</a>.</li>
</ul>

<h2>üëã</h2>

                </div>
            </section>

            <!-- Email subscribe form at the bottom of the page -->
            

            <footer class="post-full-footer">
                <!-- Everything inside the #author tags pulls data from the author -->
                <!-- #author-->
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                        <section class="author-card">
                            
                                <img class="author-profile-image" src="/assets/images/manuelvicnt.jpg" alt="manuel" />
                            
                            <section class="author-card-content">
                                <h4 class="author-card-name"><a href="/author/manuel">Manuel Vivo</a></h4>
                                
                                    <p>Android Developer Relations @ Google</p>
                                
                            </section>
                        </section>
                        <div class="post-full-footer-right">
                            <a class="author-card-button" href="/author/manuel">Read More</a>
                        </div>
                    
                
                <!-- /author  -->
            </footer>

            <!-- If you use Disqus comments, just uncomment this block.
            The only thing you need to change is "test-apkdzgmqhj" - which
            should be replaced with your own Disqus site-id. -->
            
                <section class="post-full-comments">
                    <div id="disqus_thread"></div>
                    <script>
                        var disqus_config = function () {
                            this.page.url = 'https://manuelvivo.dev/blueprints-migration-compose';
                            this.page.identifier = '/blueprints-migration-compose';
                            this.page.title = 'Migrating Architecture Blueprints to Jetpack Compose';
                        };
                        (function() {
                            var d = document, s = d.createElement('script');
                            s.src = 'https://manuelvivo.disqus.com/embed.js';
                            s.setAttribute('data-timestamp', +new Date());
                            (d.head || d.body).appendChild(s);
                        })();
                    </script>
                </section>
            

        </article>

    </div>
</main>

<!-- Links to Previous/Next posts -->
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            
                
                
                
                
                    <article class="read-next-card"
                        
                            style="background-image: url(/assets/images/blog-cover.jpg)"
                        
                    >
                        <header class="read-next-card-header">
                            <small class="read-next-card-header-sitetitle">&mdash; Manuel Vivo .dev &mdash;</small>
                            
                                <h3 class="read-next-card-header-title"><a href="/tag/architecture/">Architecture</a></h3>
                            
                        </header>
                        <div class="read-next-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
</div>
                        <div class="read-next-card-content">
                            <ul>
                                
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/mobile-system-design-interview">Mobile System Design Interview book</a></li>
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/crash-course-ui-layer-part-2">Crash Course on the Android UI Layer | Part 2</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/crash-course-ui-layer-part-1">Crash Course on the Android UI Layer | Part 1</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                            </ul>
                        </div>
                        <footer class="read-next-card-footer">
                            <a href="/tag/architecture/">
                                
                                    See all 9 posts  ‚Üí
                                
                            </a>
                        </footer>
                    </article>
                
            

            <!-- If there's a next post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/viewmodel-events-antipatterns">
                <div class="post-card-image" style="background-image: url(/assets/images/2022-06-01-viewmodel-events-antipatterns.png)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/viewmodel-events-antipatterns">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Architecture</span>
                            
                        
                    

                    <h2 class="post-card-title">ViewModel One-off event antipatterns</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p></p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                        
                        <img class="author-profile-image" src="/assets/images/manuelvicnt.jpg" alt="Manuel Vivo" />
                        
                        <span class="post-card-author">
                            <a href="/author/manuel/">Manuel Vivo</a>
                        </span>
                    
                
                <span class="reading-time">
                    
                    
                      1 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

            <!-- If there's a previous post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/new-app-architecture">
                <div class="post-card-image" style="background-image: url(/assets/images/2021-12-14-new-app-architecture.png)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/new-app-architecture">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Architecture</span>
                            
                        
                    

                    <h2 class="post-card-title">Rebuilding our guide to app architecture</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p></p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                        
                        <img class="author-profile-image" src="/assets/images/manuelvicnt.jpg" alt="Manuel Vivo" />
                        
                        <span class="post-card-author">
                            <a href="/author/manuel/">Manuel Vivo</a>
                        </span>
                    
                
                <span class="reading-time">
                    
                    
                      1 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

        </div>
    </div>
</aside>

<!-- Floating header which appears on-scroll, included from includes/floating-header.hbs -->
<div class="floating-header">
    <div class="floating-header-logo">
        <a href="https://manuelvivo.dev/">
            
            <span>Manuel Vivo .dev</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">Migrating Architecture Blueprints to Jetpack Compose</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=Migrating+Architecture+Blueprints+to+Jetpack+Compose&amp;url=https://manuelvivo.dev/blueprints-migration-compose"
            onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https://manuelvivo.dev/blueprints-migration-compose"
            onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>

        </a>
    </div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>


<!-- /post -->

<!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs -->


        <!-- Previous/next page links - displayed on every page -->
        

        <!-- The footer at the very bottom of the screen -->
        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="https://manuelvivo.dev/">Manuel Vivo .dev</a> &copy; 2025</section>
                <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> &
                    <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a> using
                    <a href="https://github.com/jekyller/jasper2" target="_blank" rel="noopener">Jasper2</a></section>
                <nav class="site-footer-nav">
                    <a href="/">Latest Posts</a>
                    
                    <a href="https://twitter.com/manuelvicnt" target="_blank" rel="noopener">Twitter</a>
                    <a href="https://ghost.org" target="_blank" rel="noopener">Ghost</a>
                </nav>
            </div>
        </footer>

    </div>

    <!-- The big email subscribe modal content -->
    

    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.10.0/components/prism-abap.min.js"></script>
    <script>$(document).ready(function() {
      $('pre code').each(function(i, block) {
        hljs.highlightBlock(block);
      });
    });</script>

    <!-- jQuery + Fitvids, which makes all video embeds responsive -->
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://demo.ghost.io/assets/js/jquery.fitvids.js?v=724281a32e"></script>


    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->

    


    <!-- Add Google Analytics  -->
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8WG7TD0NF4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8WG7TD0NF4');
</script>


    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
    
        <script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>

    

    <!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag -->
    <!-- ghost_foot -->

    <!-- Jekyll Ideal Image Slider Include -->
<!-- https://github.com/jekylltools/jekyll-ideal-image-slider-include -->
<!-- v1.8 -->

</body>
</html>

<!DOCTYPE html>
<html>
<head>

    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Base Meta -->
    <!-- dynamically fixing the title for tag/author pages -->



    <title>The suspend modifier ‚Äî under the hood</title>

    <!-- This tag outputs SEO meta+structured data and other important settings -->
    <meta name="description" content="A place where you can learn about Android development" />
    <link rel="shortcut icon" href="https://manuelvivo.dev/assets/images/favicon.png" type="image/png" />
    <link rel="canonical" href="https://manuelvivo.dev/suspend-modifier" />
    <meta name="referrer" content="no-referrer-when-downgrade" />

     <!--title below is coming from _includes/dynamic_title-->
    <meta property="og:site_name" content="Manuel Vivo .dev" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="The suspend modifier ‚Äî under the hood" />
    <meta property="og:description" content="How is the compiler transforming the code to be able to suspend and resume the execution of coroutines? Kotlin coroutines introduced the suspend modifier in our daily life as Android developers. Are you curious to see what‚Äôs happening under the hood? How is the compiler transforming the code to be" />
    <meta property="og:url" content="https://manuelvivo.dev/suspend-modifier" />
    <meta property="og:image" content="https://manuelvivo.dev/assets/images/2019-03-24-suspend-modifier.webp" />
    <meta property="article:publisher" content="https://www.facebook.com/" />
    <meta property="article:author" content="https://www.facebook.com/" />
    <meta property="article:published_time" content="2019-03-24T00:00:00+00:00" />
    <meta property="article:modified_time" content="2019-03-24T00:00:00+00:00" />
    <meta property="article:tag" content="Coroutines" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="The suspend modifier ‚Äî under the hood" />
    <meta name="twitter:description" content="How is the compiler transforming the code to be able to suspend and resume the execution of coroutines? Kotlin coroutines introduced the suspend modifier in our daily life as Android developers. Are you curious to see what‚Äôs happening under the hood? How is the compiler transforming the code to be" />
    <meta name="twitter:url" content="https://manuelvivo.dev/" />
    <meta name="twitter:image" content="https://manuelvivo.dev/assets/images/2019-03-24-suspend-modifier.webp" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Manuel Vivo .dev" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Coroutines" />
    <meta name="twitter:site" content="@manuelvicnt" />
    <meta name="twitter:creator" content="@manuelvicnt" />
    <meta property="og:image:width" content="1400" />
    <meta property="og:image:height" content="933" />

    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Website",
    "publisher": {
        "@type": "Organization",
        "name": "Manuel Vivo .dev",
        "logo": "https://manuelvivo.dev/"
    },
    "url": "https://manuelvivo.dev/suspend-modifier",
    "image": {
        "@type": "ImageObject",
        "url": "https://manuelvivo.dev/assets/images/2019-03-24-suspend-modifier.webp",
        "width": 2000,
        "height": 666
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://manuelvivo.dev/suspend-modifier"
    },
    "description": "How is the compiler transforming the code to be able to suspend and resume the execution of coroutines? Kotlin coroutines introduced the suspend modifier in our daily life as Android developers. Are you curious to see what‚Äôs happening under the hood? How is the compiler transforming the code to be"
}
    </script>

<!-- <script type="text/javascript" src="https://demo.ghost.io/public/ghost-sdk.min.js?v=724281a32e"></script>
<script type="text/javascript">
ghost.init({
	clientId: "ghost-frontend",
	clientSecret: "f84a07a72b17"
});
</script> -->

<meta name="generator" content="Jekyll 3.6.2" />
<link rel="alternate" type="application/rss+xml" title="The suspend modifier ‚Äî under the hood" href="/feed.xml" />

<style>
    .highlighter-rouge, .highlight, code {
        width: 100%;
    }
</style>

<!-- Jekyll Ideal Image Slider Include -->
<!-- https://github.com/jekylltools/jekyll-ideal-image-slider-include -->
<!-- v1.8 -->

    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>The suspend modifier ‚Äî under the hood | Manuel Vivo .dev</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="The suspend modifier ‚Äî under the hood" />
<meta name="author" content="Manuel Vivo" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="How is the compiler transforming the code to be able to suspend and resume the execution of coroutines?" />
<meta property="og:description" content="How is the compiler transforming the code to be able to suspend and resume the execution of coroutines?" />
<link rel="canonical" href="https://manuelvivo.dev/suspend-modifier" />
<meta property="og:url" content="https://manuelvivo.dev/suspend-modifier" />
<meta property="og:site_name" content="Manuel Vivo .dev" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-03-24T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="The suspend modifier ‚Äî under the hood" />
<meta name="twitter:site" content="@" />
<meta name="twitter:creator" content="@manuelvicnt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Manuel Vivo","url":"github.com/manuelvicnt"},"dateModified":"2019-03-24T00:00:00+00:00","datePublished":"2019-03-24T00:00:00+00:00","description":"How is the compiler transforming the code to be able to suspend and resume the execution of coroutines?","headline":"The suspend modifier ‚Äî under the hood","mainEntityOfPage":{"@type":"WebPage","@id":"https://manuelvivo.dev/suspend-modifier"},"url":"https://manuelvivo.dev/suspend-modifier"}</script>
<!-- End Jekyll SEO tag -->


    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.edited.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/syntax.css" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css?family=Montserrat&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Inter&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro&display=swap" rel="stylesheet">

    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!--[if IE]>
        <style>
            p, ol, ul{
                width: 100%;
            }
            blockquote{
                width: 100%;
            }
        </style>
    <![endif]-->
</head>
<body class="post-template">

    <div class="site-wrapper">
        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left">
        
            
                <a class="site-nav-logo" href="https://manuelvivo.dev/">Manuel Vivo .dev</a>
            
        
        
            <ul class="nav" role="menu">
    <li class="nav-home" role="menuitem"><a href="/">Home</a></li>
    <li class="nav-book" role="menuitem"><a href="https://topmate.io/manuelvivo" target="_blank">üóìÔ∏è Book a 1:1 with me!</a></li>
    <li class="nav-digitalproduct" role="menuitem"><a href="/digitalproduct/">Products</a></li>
    <li class="nav-publicspeaking" role="menuitem"><a href="/publicspeaking/">Public Speaking</a></li>
    <li class="nav-about" role="menuitem"><a href="/about/">About</a></li>
    <li class="nav-gallery" role="menuitem"><a href="/gallery/">Gallery</a></li>
</ul>
        
    </div>
    <div class="site-nav-right">
        <div class="social-links">
            
            
                <a class="social-link social-link-tw" href="https://twitter.com/manuelvicnt" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>
</a>
            
        </div>
        
    </div>
</nav>

    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full  tag-coroutines post ">

            <header class="post-full-header">
              <section class="post-full-meta">
                  <time class="post-full-meta-date" datetime="24 March 2019">24 March 2019</time>
              </section>

              
                  
                    <span class="post-card-tags"><a style="color:white;" href='/tag/coroutines/'>Coroutines</a></span>
                  
              
                <h1 class="post-full-title">The suspend modifier ‚Äî under the hood</h1>
            </header>

            
            <figure class="post-full-image" style="background-image: url(/assets/images/2019-03-24-suspend-modifier.webp)">
            </figure>
            

            <section class="post-full-content">
                <div class="kg-card-markdown">
                    <p>How is the compiler transforming the code to be able to suspend and resume the execution of coroutines?</p>

<p>Kotlin coroutines introduced the <strong><em>suspend modifier</em></strong> in our daily life as Android developers. Are you curious to see what‚Äôs happening under the hood? How is the compiler transforming the code to be able to suspend and resume the execution of coroutines?</p>

<p>Knowing this will help you better understand why a suspend function won‚Äôt return until all the work that it started has completed and how the code can suspend without blocking threads.</p>

<blockquote>
  <p><strong>TL;DR;</strong> The Kotlin compiler will create a state machine for every suspend function that manages the coroutine‚Äôs execution for us!</p>
</blockquote>

<p>üìö New to coroutines on Android? Check out these Coroutines codelabs:</p>

<ul>
  <li>
    <p><a href="https://codelabs.developers.google.com/codelabs/kotlin-coroutines/#0">Using coroutines in your Android app</a></p>
  </li>
  <li>
    <p><a href="https://codelabs.developers.google.com/codelabs/advanced-kotlin-coroutines/#0">Advanced Coroutines with Kotlin Flow and Live Data</a></p>
  </li>
</ul>

<p>If you prefer to watch a video about this, check this out:</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/IQf-vtIC-Uc" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

<h2 id="coroutines-101">Coroutines 101</h2>

<p>Coroutines simplify asynchronous operations on Android. As explained in the <a href="https://developer.android.com/kotlin/coroutines">documentation</a>, we can use them to manage asynchronous tasks that might otherwise block the main thread and cause your app to freeze.</p>

<p>Coroutines are also helpful to replace callback-based APIs with imperative looking code. As example, check out this asynchronous code that uses callbacks:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Simplified code that only considers the happy path</span>
<span class="k">fun</span> <span class="nf">loginUser</span><span class="p">(</span><span class="n">userId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">userResult</span><span class="p">:</span> <span class="nc">Callback</span><span class="p">&lt;</span><span class="nc">User</span><span class="p">&gt;)</span> <span class="p">{</span>
  <span class="c1">// Async callbacks</span>
  <span class="n">userRemoteDataSource</span><span class="p">.</span><span class="nf">logUserIn</span> <span class="p">{</span> <span class="n">user</span> <span class="p">-&gt;</span>
    <span class="c1">// Successful network request</span>
    <span class="n">userLocalDataSource</span><span class="p">.</span><span class="nf">logUserIn</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">{</span> <span class="n">userDb</span> <span class="p">-&gt;</span>
      <span class="c1">// Result saved in DB</span>
      <span class="n">userResult</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="n">userDb</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Those callbacks can be converted to sequential function calls using coroutines:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">suspend</span> <span class="k">fun</span> <span class="nf">loginUser</span><span class="p">(</span><span class="n">userId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">User</span> <span class="p">{</span>
  <span class="kd">val</span> <span class="py">user</span> <span class="p">=</span> <span class="n">userRemoteDataSource</span><span class="p">.</span><span class="nf">logUserIn</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
  <span class="kd">val</span> <span class="py">userDb</span> <span class="p">=</span> <span class="n">userLocalDataSource</span><span class="p">.</span><span class="nf">logUserIn</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">userDb</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In the coroutines code, we added the <strong>suspend</strong> modifier to the function. That tells the compiler that this function needs to be executed inside a coroutine. As a developer, you can think of a suspend function as a regular function whose execution might be suspended and resumed at some point.</p>

<p>Unlike callbacks, coroutines provide an easy way to swap between threads and handle exceptions.</p>

<p>But, what‚Äôs the compiler actually doing under the hood when we mark the function as <em>suspend</em>?</p>

<h2 id="suspend-under-the-hood">Suspend under the hood</h2>

<p>Back to the <code class="language-plaintext highlighter-rouge">loginUser</code> suspend function, notice that the other functions it calls are also suspend functions:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">suspend</span> <span class="k">fun</span> <span class="nf">loginUser</span><span class="p">(</span><span class="n">userId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">User</span> <span class="p">{</span>
  <span class="kd">val</span> <span class="py">user</span> <span class="p">=</span> <span class="n">userRemoteDataSource</span><span class="p">.</span><span class="nf">logUserIn</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
  <span class="kd">val</span> <span class="py">userDb</span> <span class="p">=</span> <span class="n">userLocalDataSource</span><span class="p">.</span><span class="nf">logUserIn</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">userDb</span>
<span class="p">}</span>

<span class="c1">// UserRemoteDataSource.kt</span>
<span class="k">suspend</span> <span class="k">fun</span> <span class="nf">logUserIn</span><span class="p">(</span><span class="n">userId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">User</span>

<span class="c1">// UserLocalDataSource.kt</span>
<span class="k">suspend</span> <span class="k">fun</span> <span class="nf">logUserIn</span><span class="p">(</span><span class="n">userId</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">UserDb</span>
</code></pre></div></div>

<p>In a nutshell, the Kotlin compiler will take suspend functions and convert them to an optimised version of callbacks using a <a href="https://en.wikipedia.org/wiki/Finite-state_machine"><strong>finite state machine</strong></a> (which we‚Äôll cover later).</p>

<p>You got it right, <strong>the compiler will write those callbacks for you</strong>!</p>

<h3 id="continuation-interface">Continuation interface</h3>

<p>The way suspend functions communicate with each other is with <code class="language-plaintext highlighter-rouge">Continuation</code> objects. A <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.coroutines/-continuation/index.html"><code class="language-plaintext highlighter-rouge">Continuation</code></a> is just a generic callback interface with some extra information. As we will see later, it will represent the generated state machine of a suspend function.</p>

<p>Let‚Äôs take a look at its definition:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">interface</span> <span class="nc">Continuation</span><span class="p">&lt;</span><span class="k">in</span> <span class="nc">T</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="k">public</span> <span class="kd">val</span> <span class="py">context</span><span class="p">:</span> <span class="nc">CoroutineContext</span>
  <span class="k">public</span> <span class="k">fun</span> <span class="nf">resumeWith</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nc">Result</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;)</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">context</code> will be the <code class="language-plaintext highlighter-rouge">CoroutineContext</code> to be used in that continuation.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">resumeWith</code> resumes execution of the coroutine with a <a href="https://github.com/Kotlin/kotlinx.coroutines/blob/master/stdlib-stubs/src/Result.kt"><code class="language-plaintext highlighter-rouge">Result</code></a>, that can contain either a value which is the result of the computation that caused the suspension or an exception.</p>
  </li>
</ul>

<p>Note: From Kotlin 1.3 onwards, you can also use the extension functions <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.coroutines/resume.html"><code class="language-plaintext highlighter-rouge">resume(value: T)</code></a> and <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.coroutines/resume-with-exception.html"><code class="language-plaintext highlighter-rouge">resumeWithException(exception: Throwable)</code></a> which are specialised versions of the <code class="language-plaintext highlighter-rouge">resumeWith</code> call.</p>

<p>The compiler will replace the suspend modifier with the extra parameter <code class="language-plaintext highlighter-rouge">completion</code> (of type <code class="language-plaintext highlighter-rouge">Continuation</code>) in the function signature that will be used to communicate the result of the suspend function to the coroutine that called it:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">loginUser</span><span class="p">(</span><span class="n">userId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">completion</span><span class="p">:</span> <span class="nc">Continuation</span><span class="p">&lt;</span><span class="nc">Any</span><span class="err">?</span><span class="p">&gt;)</span> <span class="p">{</span>
  <span class="kd">val</span> <span class="py">user</span> <span class="p">=</span> <span class="n">userRemoteDataSource</span><span class="p">.</span><span class="nf">logUserIn</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
  <span class="kd">val</span> <span class="py">userDb</span> <span class="p">=</span> <span class="n">userLocalDataSource</span><span class="p">.</span><span class="nf">logUserIn</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">completion</span><span class="p">.</span><span class="nf">resume</span><span class="p">(</span><span class="n">userDb</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>For simplicity, our example will return <code class="language-plaintext highlighter-rouge">Unit</code> instead of <code class="language-plaintext highlighter-rouge">User</code>. The <code class="language-plaintext highlighter-rouge">User</code> object will be ‚Äúreturned‚Äù in the added <code class="language-plaintext highlighter-rouge">Continuation</code> parameter.</p>

<p>The bytecode of suspend functions actually return <code class="language-plaintext highlighter-rouge">Any?</code> because it‚Äôs a union type of <code class="language-plaintext highlighter-rouge">T | COROUTINE_SUSPENDED</code>. That allows the function to return synchronously when it can.</p>

<blockquote>
  <p>Note: If you mark a function that doesn‚Äôt call other suspend functions with the suspend modifier, the compiler will add the extra Continuation parameter but won‚Äôt do anything with it, the function body‚Äôs bytecode will look like a regular function.</p>
</blockquote>

<p>You can also see the <code class="language-plaintext highlighter-rouge">Continuation</code> interface in other places:</p>

<ul>
  <li>
    <p>When converting callback-based APIs to coroutines using <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.coroutines/suspend-coroutine.html"><code class="language-plaintext highlighter-rouge">suspendCoroutine</code></a> or <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/suspend-cancellable-coroutine.html"><code class="language-plaintext highlighter-rouge">suspendCancellableCoroutine</code></a> (which you should always prefer), you directly interact with a <code class="language-plaintext highlighter-rouge">Continuation</code> object to resume the coroutine that got suspended after running the block of code passed as a parameter.</p>
  </li>
  <li>
    <p>You can start a coroutine with the <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.coroutines/start-coroutine.html"><code class="language-plaintext highlighter-rouge">startCoroutine</code></a> extension function on a suspend function. It takes a <code class="language-plaintext highlighter-rouge">Continuation</code> object as a parameter that will get called when the new coroutine finishes with either a result or an exception.</p>
  </li>
</ul>

<h3 id="using-different-dispatchers">Using different Dispatchers</h3>

<p>You can swap between different Dispatchers to execute computations on different threads. How does Kotlin know where to resume a suspended computation?</p>

<p>There‚Äôs a subtype of <code class="language-plaintext highlighter-rouge">Continuation</code> called <a href="https://github.com/Kotlin/kotlinx.coroutines/blob/master/kotlinx-coroutines-core/common/src/internal/DispatchedContinuation.kt"><code class="language-plaintext highlighter-rouge">DispatchedContinuation</code></a> whose resume function makes a dispatch call to the <code class="language-plaintext highlighter-rouge">Dispatcher</code> available in the <code class="language-plaintext highlighter-rouge">CoroutineContext</code>. All <code class="language-plaintext highlighter-rouge">Dispatchers</code> will call dispatch except <code class="language-plaintext highlighter-rouge">Dispatchers.Unconfined</code> whose <code class="language-plaintext highlighter-rouge">isDispatchNeeded</code> function override (that is called before <code class="language-plaintext highlighter-rouge">dispatch</code>) always returns <code class="language-plaintext highlighter-rouge">false</code>.</p>

<h2 id="the-generated-state-machine">The generated State machine</h2>

<blockquote>
  <p><strong>Disclaimer</strong>: The code to be shown in the rest of the article will not fully match the bytecode generated by the compiler. It will be Kotlin code accurate enough to allow you to understand what‚Äôs really happening internally. This representation is generated by Coroutines version 1.3.3 and might change in future versions of the library.</p>
</blockquote>

<p>The Kotlin compiler will identify when the function can suspend internally. Every suspension point will be represented as a state in the finite state machine. These states are represented with labels by the compiler:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">loginUser</span><span class="p">(</span><span class="n">userId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">completion</span><span class="p">:</span> <span class="nc">Continuation</span><span class="p">&lt;</span><span class="nc">Any</span><span class="err">?</span><span class="p">&gt;)</span> <span class="p">{</span>
  
  <span class="c1">// Label 0 -&gt; first execution</span>
  <span class="kd">val</span> <span class="py">user</span> <span class="p">=</span> <span class="n">userRemoteDataSource</span><span class="p">.</span><span class="nf">logUserIn</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
  
  <span class="c1">// Label 1 -&gt; resumes from userRemoteDataSource</span>
  <span class="kd">val</span> <span class="py">userDb</span> <span class="p">=</span> <span class="n">userLocalDataSource</span><span class="p">.</span><span class="nf">logUserIn</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  
  <span class="c1">// Label 2 -&gt; resumes from userLocalDataSource</span>
  <span class="n">completion</span><span class="p">.</span><span class="nf">resume</span><span class="p">(</span><span class="n">userDb</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>For a better representation of the state machine, the compiler will use a <code class="language-plaintext highlighter-rouge">when</code> statement to implement the different states:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">loginUser</span><span class="p">(</span><span class="n">userId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">completion</span><span class="p">:</span> <span class="nc">Continuation</span><span class="p">&lt;</span><span class="nc">Any</span><span class="err">?</span><span class="p">&gt;)</span> <span class="p">{</span>
  <span class="k">when</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="p">{</span>
    <span class="mi">0</span> <span class="p">-&gt;</span> <span class="p">{</span> <span class="c1">// Label 0 -&gt; first execution</span>
        <span class="n">userRemoteDataSource</span><span class="p">.</span><span class="nf">logUserIn</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="mi">1</span> <span class="p">-&gt;</span> <span class="p">{</span> <span class="c1">// Label 1 -&gt; resumes from userRemoteDataSource</span>
        <span class="n">userLocalDataSource</span><span class="p">.</span><span class="nf">logUserIn</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="mi">2</span> <span class="p">-&gt;</span> <span class="p">{</span> <span class="c1">// Label 2 -&gt; resumes from userLocalDataSource</span>
        <span class="n">completion</span><span class="p">.</span><span class="nf">resume</span><span class="p">(</span><span class="n">userDb</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">-&gt;</span> <span class="k">throw</span> <span class="nc">IllegalStateException</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This code is incomplete since the different states have no way to share information. The compiler will use the same <code class="language-plaintext highlighter-rouge">Continuation</code> object in the function to do it. This is why the generic of the <code class="language-plaintext highlighter-rouge">Continuation</code> is <code class="language-plaintext highlighter-rouge">Any?</code> instead of the return type of the original function (i.e. <code class="language-plaintext highlighter-rouge">User</code>).</p>

<p>Furthermore, the compiler will create a private class that 1) holds the required data and 2) calls the <code class="language-plaintext highlighter-rouge">loginUser</code> function recursively to resume execution. You can check out an approximation of the generated class below.</p>

<blockquote>
  <p><strong>Disclaimer</strong>: Comments are not generated by the compiler. I added them to explain what they do and make following the code easier to follow.</p>
</blockquote>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">loginUser</span><span class="p">(</span><span class="n">userId</span><span class="p">:</span> <span class="nc">String</span><span class="p">?,</span> <span class="n">password</span><span class="p">:</span> <span class="nc">String</span><span class="p">?,</span> <span class="n">completion</span><span class="p">:</span> <span class="nc">Continuation</span><span class="p">&lt;</span><span class="nc">Any</span><span class="err">?</span><span class="p">&gt;)</span> <span class="p">{</span>
  
  <span class="kd">class</span> <span class="nc">LoginUserStateMachine</span><span class="p">(</span>
    <span class="c1">// completion parameter is the callback to the function </span>
    <span class="c1">// that called loginUser</span>
    <span class="n">completion</span><span class="p">:</span> <span class="nc">Continuation</span><span class="p">&lt;</span><span class="nc">Any</span><span class="err">?</span><span class="p">&gt;</span>
  <span class="p">):</span> <span class="nc">CoroutineImpl</span><span class="p">(</span><span class="n">completion</span><span class="p">)</span> <span class="p">{</span>
  
    <span class="c1">// Local variables of the suspend function</span>
    <span class="kd">var</span> <span class="py">user</span><span class="p">:</span> <span class="nc">User</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
    <span class="kd">var</span> <span class="py">userDb</span><span class="p">:</span> <span class="nc">UserDb</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
  
    <span class="c1">// Common objects for all CoroutineImpls</span>
    <span class="kd">var</span> <span class="py">result</span><span class="p">:</span> <span class="nc">Any</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
    <span class="kd">var</span> <span class="py">label</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">=</span> <span class="mi">0</span>
  
    <span class="c1">// this function calls the loginUser again to trigger the</span>
    <span class="c1">// state machine (label will be already in the next state) and</span>
    <span class="c1">// result will be the result of the previous state's computation</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">invokeSuspend</span><span class="p">(</span><span class="n">result</span><span class="p">:</span> <span class="nc">Any</span><span class="p">?)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="n">result</span> <span class="p">=</span> <span class="n">result</span>
      <span class="nf">loginUser</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="cm">/* ... */</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As <code class="language-plaintext highlighter-rouge">invokeSuspend</code> will call <code class="language-plaintext highlighter-rouge">loginUser</code> again with just the information of the <code class="language-plaintext highlighter-rouge">Continuation</code> object, the rest of parameters in the <code class="language-plaintext highlighter-rouge">loginUser</code> function signature become nullable. At this point, the compiler just needs to add information on how to move between states.</p>

<p>The first thing it needs to do is know if 1) it‚Äôs the first time the function is called or 2) the function has resumed from a previous state. It does it by checking if the continuation passed in is of type <code class="language-plaintext highlighter-rouge">LoginUserStateMachine</code> or not:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">loginUser</span><span class="p">(</span><span class="n">userId</span><span class="p">:</span> <span class="nc">String</span><span class="p">?,</span> <span class="n">password</span><span class="p">:</span> <span class="nc">String</span><span class="p">?,</span> <span class="n">completion</span><span class="p">:</span> <span class="nc">Continuation</span><span class="p">&lt;</span><span class="nc">Any</span><span class="err">?</span><span class="p">&gt;)</span> <span class="p">{</span>
  <span class="cm">/* ... */</span>
  <span class="kd">val</span> <span class="py">continuation</span> <span class="p">=</span> <span class="n">completion</span> <span class="k">as</span><span class="p">?</span> <span class="nc">LoginUserStateMachine</span> <span class="o">?:</span> <span class="nc">LoginUserStateMachine</span><span class="p">(</span><span class="n">completion</span><span class="p">)</span>
  <span class="cm">/* ... */</span>
<span class="p">}</span>
</code></pre></div></div>

<p>If it‚Äôs the first time, it will create a new <code class="language-plaintext highlighter-rouge">LoginUserStateMachine</code> instance and will store the <code class="language-plaintext highlighter-rouge">completion</code> instance received as a parameter so that it remembers how to resume the function that called this one. If it‚Äôs not, it will just carry on executing the state machine (the suspend function).</p>

<p>Now, let‚Äôs see the code that the compiler generates for moving between states and sharing information between them.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">loginUser</span><span class="p">(</span><span class="n">userId</span><span class="p">:</span> <span class="nc">String</span><span class="p">?,</span> <span class="n">password</span><span class="p">:</span> <span class="nc">String</span><span class="p">?,</span> <span class="n">completion</span><span class="p">:</span> <span class="nc">Continuation</span><span class="p">&lt;</span><span class="nc">Any</span><span class="err">?</span><span class="p">&gt;)</span> <span class="p">{</span>
    <span class="cm">/* ... */</span>

    <span class="kd">val</span> <span class="py">continuation</span> <span class="p">=</span> <span class="n">completion</span> <span class="k">as</span><span class="p">?</span> <span class="nc">LoginUserStateMachine</span> <span class="o">?:</span> <span class="nc">LoginUserStateMachine</span><span class="p">(</span><span class="n">completion</span><span class="p">)</span>

    <span class="k">when</span><span class="p">(</span><span class="n">continuation</span><span class="p">.</span><span class="n">label</span><span class="p">)</span> <span class="p">{</span>
        <span class="mi">0</span> <span class="p">-&gt;</span> <span class="p">{</span>
            <span class="c1">// Checks for failures</span>
            <span class="nf">throwOnFailure</span><span class="p">(</span><span class="n">continuation</span><span class="p">.</span><span class="n">result</span><span class="p">)</span>
            <span class="c1">// Next time this continuation is called, it should go to state 1</span>
            <span class="n">continuation</span><span class="p">.</span><span class="n">label</span> <span class="p">=</span> <span class="mi">1</span>
            <span class="c1">// The continuation object is passed to logUserIn to resume </span>
            <span class="c1">// this state machine's execution when it finishes</span>
            <span class="n">userRemoteDataSource</span><span class="p">.</span><span class="nf">logUserIn</span><span class="p">(</span><span class="n">userId</span><span class="o">!!</span><span class="p">,</span> <span class="n">password</span><span class="o">!!</span><span class="p">,</span> <span class="n">continuation</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="mi">1</span> <span class="p">-&gt;</span> <span class="p">{</span>
            <span class="c1">// Checks for failures</span>
            <span class="nf">throwOnFailure</span><span class="p">(</span><span class="n">continuation</span><span class="p">.</span><span class="n">result</span><span class="p">)</span>
            <span class="c1">// Gets the result of the previous state</span>
            <span class="n">continuation</span><span class="p">.</span><span class="n">user</span> <span class="p">=</span> <span class="n">continuation</span><span class="p">.</span><span class="n">result</span> <span class="k">as</span> <span class="nc">User</span>
            <span class="c1">// Next time this continuation is called, it should go to state 2</span>
            <span class="n">continuation</span><span class="p">.</span><span class="n">label</span> <span class="p">=</span> <span class="mi">2</span>
            <span class="c1">// The continuation object is passed to logUserIn to resume </span>
            <span class="c1">// this state machine's execution when it finishes</span>
            <span class="n">userLocalDataSource</span><span class="p">.</span><span class="nf">logUserIn</span><span class="p">(</span><span class="n">continuation</span><span class="p">.</span><span class="n">user</span><span class="p">,</span> <span class="n">continuation</span><span class="p">)</span>
        <span class="p">}</span>
          <span class="cm">/* ... leaving out the last state on purpose */</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Spend some time going through the code above and see if you can spot the differences with the previous snippets of code. Let‚Äôs see what the compiler generates:</p>

<ul>
  <li>
    <p>The <code class="language-plaintext highlighter-rouge">when</code> statement‚Äôs argument is the <code class="language-plaintext highlighter-rouge">label</code> from inside the <code class="language-plaintext highlighter-rouge">LoginUserStateMachine</code> instance.</p>
  </li>
  <li>
    <p>Every time a new state is processed, there‚Äôs a check in case a failure happened when this function was suspended.</p>
  </li>
  <li>
    <p>Before calling the next suspend function (i.e. <code class="language-plaintext highlighter-rouge">logUserIn</code>), the <code class="language-plaintext highlighter-rouge">label</code> of the <code class="language-plaintext highlighter-rouge">LoginUserStateMachine</code> instance is updated to the next state.</p>
  </li>
  <li>
    <p>When inside this state machine there‚Äôs a call to another suspend function, the instance of the <code class="language-plaintext highlighter-rouge">continuation</code> (of type <code class="language-plaintext highlighter-rouge">LoginUserStateMachine</code>) is passed as a parameter. The suspend function to be called has also been transformed by the compiler and it‚Äôs another state machine like this one that takes a continuation object as a parameter! When the state machine of that suspend function finishes, it will resume the execution of this state machine.</p>
  </li>
</ul>

<p>The last state is different since it has to resume the execution of the function that called this one, as you can see in the code, it calls resume on the cont variable stored (at construction time) in <code class="language-plaintext highlighter-rouge">LoginUserStateMachine</code>:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">loginUser</span><span class="p">(</span><span class="n">userId</span><span class="p">:</span> <span class="nc">String</span><span class="p">?,</span> <span class="n">password</span><span class="p">:</span> <span class="nc">String</span><span class="p">?,</span> <span class="n">completion</span><span class="p">:</span> <span class="nc">Continuation</span><span class="p">&lt;</span><span class="nc">Any</span><span class="err">?</span><span class="p">&gt;)</span> <span class="p">{</span>
    <span class="cm">/* ... */</span>

    <span class="kd">val</span> <span class="py">continuation</span> <span class="p">=</span> <span class="n">completion</span> <span class="k">as</span><span class="p">?</span> <span class="nc">LoginUserStateMachine</span> <span class="o">?:</span> <span class="nc">LoginUserStateMachine</span><span class="p">(</span><span class="n">completion</span><span class="p">)</span>

    <span class="k">when</span><span class="p">(</span><span class="n">continuation</span><span class="p">.</span><span class="n">label</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* ... */</span>
        <span class="mi">2</span> <span class="p">-&gt;</span> <span class="p">{</span>
            <span class="c1">// Checks for failures</span>
            <span class="nf">throwOnFailure</span><span class="p">(</span><span class="n">continuation</span><span class="p">.</span><span class="n">result</span><span class="p">)</span>
            <span class="c1">// Gets the result of the previous state</span>
            <span class="n">continuation</span><span class="p">.</span><span class="n">userDb</span> <span class="p">=</span> <span class="n">continuation</span><span class="p">.</span><span class="n">result</span> <span class="k">as</span> <span class="nc">UserDb</span>
            <span class="c1">// Resumes the execution of the function that called this one</span>
            <span class="n">continuation</span><span class="p">.</span><span class="n">cont</span><span class="p">.</span><span class="nf">resume</span><span class="p">(</span><span class="n">continuation</span><span class="p">.</span><span class="n">userDb</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">-&gt;</span> <span class="k">throw</span> <span class="nc">IllegalStateException</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As you see, the Kotlin compiler is doing a lot for us! From this suspend function:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">suspend</span> <span class="k">fun</span> <span class="nf">loginUser</span><span class="p">(</span><span class="n">userId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">User</span> <span class="p">{</span>
  <span class="kd">val</span> <span class="py">user</span> <span class="p">=</span> <span class="n">userRemoteDataSource</span><span class="p">.</span><span class="nf">logUserIn</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
  <span class="kd">val</span> <span class="py">userDb</span> <span class="p">=</span> <span class="n">userLocalDataSource</span><span class="p">.</span><span class="nf">logUserIn</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">userDb</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The compiler generated all of this for us:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">loginUser</span><span class="p">(</span><span class="n">userId</span><span class="p">:</span> <span class="nc">String</span><span class="p">?,</span> <span class="n">password</span><span class="p">:</span> <span class="nc">String</span><span class="p">?,</span> <span class="n">completion</span><span class="p">:</span> <span class="nc">Continuation</span><span class="p">&lt;</span><span class="nc">Any</span><span class="err">?</span><span class="p">&gt;)</span> <span class="p">{</span>

    <span class="kd">class</span> <span class="nc">LoginUserStateMachine</span><span class="p">(</span>
        <span class="c1">// completion parameter is the callback to the function that called loginUser</span>
        <span class="n">completion</span><span class="p">:</span> <span class="nc">Continuation</span><span class="p">&lt;</span><span class="nc">Any</span><span class="err">?</span><span class="p">&gt;</span>
    <span class="p">):</span> <span class="nc">CoroutineImpl</span><span class="p">(</span><span class="n">completion</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// objects to store across the suspend function</span>
        <span class="kd">var</span> <span class="py">user</span><span class="p">:</span> <span class="nc">User</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
        <span class="kd">var</span> <span class="py">userDb</span><span class="p">:</span> <span class="nc">UserDb</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>

        <span class="c1">// Common objects for all CoroutineImpl</span>
        <span class="kd">var</span> <span class="py">result</span><span class="p">:</span> <span class="nc">Any</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
        <span class="kd">var</span> <span class="py">label</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">=</span> <span class="mi">0</span>

        <span class="c1">// this function calls the loginUser again to trigger the </span>
        <span class="c1">// state machine (label will be already in the next state) and </span>
        <span class="c1">// result will be the result of the previous state's computation</span>
        <span class="k">override</span> <span class="k">fun</span> <span class="nf">invokeSuspend</span><span class="p">(</span><span class="n">result</span><span class="p">:</span> <span class="nc">Any</span><span class="p">?)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">result</span> <span class="p">=</span> <span class="n">result</span>
            <span class="nf">loginUser</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">val</span> <span class="py">continuation</span> <span class="p">=</span> <span class="n">completion</span> <span class="k">as</span><span class="p">?</span> <span class="nc">LoginUserStateMachine</span> <span class="o">?:</span> <span class="nc">LoginUserStateMachine</span><span class="p">(</span><span class="n">completion</span><span class="p">)</span>

    <span class="k">when</span><span class="p">(</span><span class="n">continuation</span><span class="p">.</span><span class="n">label</span><span class="p">)</span> <span class="p">{</span>
        <span class="mi">0</span> <span class="p">-&gt;</span> <span class="p">{</span>
            <span class="c1">// Checks for failures</span>
            <span class="nf">throwOnFailure</span><span class="p">(</span><span class="n">continuation</span><span class="p">.</span><span class="n">result</span><span class="p">)</span>
            <span class="c1">// Next time this continuation is called, it should go to state 1</span>
            <span class="n">continuation</span><span class="p">.</span><span class="n">label</span> <span class="p">=</span> <span class="mi">1</span>
            <span class="c1">// The continuation object is passed to logUserIn to resume </span>
            <span class="c1">// this state machine's execution when it finishes</span>
            <span class="n">userRemoteDataSource</span><span class="p">.</span><span class="nf">logUserIn</span><span class="p">(</span><span class="n">userId</span><span class="o">!!</span><span class="p">,</span> <span class="n">password</span><span class="o">!!</span><span class="p">,</span> <span class="n">continuation</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="mi">1</span> <span class="p">-&gt;</span> <span class="p">{</span>
            <span class="c1">// Checks for failures</span>
            <span class="nf">throwOnFailure</span><span class="p">(</span><span class="n">continuation</span><span class="p">.</span><span class="n">result</span><span class="p">)</span>
            <span class="c1">// Gets the result of the previous state</span>
            <span class="n">continuation</span><span class="p">.</span><span class="n">user</span> <span class="p">=</span> <span class="n">continuation</span><span class="p">.</span><span class="n">result</span> <span class="k">as</span> <span class="nc">User</span>
            <span class="c1">// Next time this continuation is called, it should go to state 2</span>
            <span class="n">continuation</span><span class="p">.</span><span class="n">label</span> <span class="p">=</span> <span class="mi">2</span>
            <span class="c1">// The continuation object is passed to logUserIn to resume </span>
            <span class="c1">// this state machine's execution when it finishes</span>
            <span class="n">userLocalDataSource</span><span class="p">.</span><span class="nf">logUserIn</span><span class="p">(</span><span class="n">continuation</span><span class="p">.</span><span class="n">user</span><span class="p">,</span> <span class="n">continuation</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="mi">2</span> <span class="p">-&gt;</span> <span class="p">{</span>
            <span class="c1">// Checks for failures</span>
            <span class="nf">throwOnFailure</span><span class="p">(</span><span class="n">continuation</span><span class="p">.</span><span class="n">result</span><span class="p">)</span>
            <span class="c1">// Gets the result of the previous state</span>
            <span class="n">continuation</span><span class="p">.</span><span class="n">userDb</span> <span class="p">=</span> <span class="n">continuation</span><span class="p">.</span><span class="n">result</span> <span class="k">as</span> <span class="nc">UserDb</span>
            <span class="c1">// Resumes the execution of the function that called this one</span>
            <span class="n">continuation</span><span class="p">.</span><span class="n">cont</span><span class="p">.</span><span class="nf">resume</span><span class="p">(</span><span class="n">continuation</span><span class="p">.</span><span class="n">userDb</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">-&gt;</span> <span class="k">throw</span> <span class="nc">IllegalStateException</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<p>The Kotlin compiler transforms every suspend function to be a state machine, which optimises using callbacks every time a function needs to suspend.</p>

<p>Knowing what the compiler does under the hood now, you can better understand why a suspend function won‚Äôt return until all the work that it started has completed. Also, how the code can suspend without blocking threads: the information of what needs to be executed when the function is resumed is stored in the <code class="language-plaintext highlighter-rouge">Continuation</code> object!</p>

                </div>
            </section>

            <!-- Email subscribe form at the bottom of the page -->
            

            <footer class="post-full-footer">
                <!-- Everything inside the #author tags pulls data from the author -->
                <!-- #author-->
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                        <section class="author-card">
                            
                                <img class="author-profile-image" src="/assets/images/manuelvicnt.jpg" alt="manuel" />
                            
                            <section class="author-card-content">
                                <h4 class="author-card-name"><a href="/author/manuel">Manuel Vivo</a></h4>
                                
                                    <p>Android Developer Relations @ Google</p>
                                
                            </section>
                        </section>
                        <div class="post-full-footer-right">
                            <a class="author-card-button" href="/author/manuel">Read More</a>
                        </div>
                    
                
                <!-- /author  -->
            </footer>

            <!-- If you use Disqus comments, just uncomment this block.
            The only thing you need to change is "test-apkdzgmqhj" - which
            should be replaced with your own Disqus site-id. -->
            
                <section class="post-full-comments">
                    <div id="disqus_thread"></div>
                    <script>
                        var disqus_config = function () {
                            this.page.url = 'https://manuelvivo.dev/suspend-modifier';
                            this.page.identifier = '/suspend-modifier';
                            this.page.title = 'The suspend modifier ‚Äî under the hood';
                        };
                        (function() {
                            var d = document, s = d.createElement('script');
                            s.src = 'https://manuelvivo.disqus.com/embed.js';
                            s.setAttribute('data-timestamp', +new Date());
                            (d.head || d.body).appendChild(s);
                        })();
                    </script>
                </section>
            

        </article>

    </div>
</main>

<!-- Links to Previous/Next posts -->
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            
                
                
                
                
                    <article class="read-next-card"
                        
                            style="background-image: url(/assets/images/blog-cover.jpg)"
                        
                    >
                        <header class="read-next-card-header">
                            <small class="read-next-card-header-sitetitle">&mdash; Manuel Vivo .dev &mdash;</small>
                            
                                <h3 class="read-next-card-header-title"><a href="/tag/coroutines/">Coroutines</a></h3>
                            
                        </header>
                        <div class="read-next-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
</div>
                        <div class="read-next-card-content">
                            <ul>
                                
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/kotlin-flows-in-practice">Kotlin Flows in practice</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/repeatonlifecycle">repeatOnLifecycle API design story</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/coroutinescope-hilt">Create an application CoroutineScope using Hilt</a></li>
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                            </ul>
                        </div>
                        <footer class="read-next-card-footer">
                            <a href="/tag/coroutines/">
                                
                                    See all 18 posts  ‚Üí
                                
                            </a>
                        </footer>
                    </article>
                
            

            <!-- If there's a next post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/dagger-kotlin-optimizations">
                <div class="post-card-image" style="background-image: url(/assets/images/2019-07-30-dagger-kotlin-optimizations.png)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/dagger-kotlin-optimizations">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Dagger</span>
                            
                        
                    

                    <h2 class="post-card-title">Dagger in Kotlin - Gotchas and Optimizations</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p></p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                        
                        <img class="author-profile-image" src="/assets/images/manuelvicnt.jpg" alt="Manuel Vivo" />
                        
                        <span class="post-card-author">
                            <a href="/author/manuel/">Manuel Vivo</a>
                        </span>
                    
                
                <span class="reading-time">
                    
                    
                      1 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

            <!-- If there's a previous post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/viewmodelscope">
                <div class="post-card-image" style="background-image: url(/assets/images/2019-03-19-viewmodelscope.png)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/viewmodelscope">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Coroutines</span>
                            
                        
                    

                    <h2 class="post-card-title">Easy Coroutines in Android - viewModelScope</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p></p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                        
                        <img class="author-profile-image" src="/assets/images/manuelvicnt.jpg" alt="Manuel Vivo" />
                        
                        <span class="post-card-author">
                            <a href="/author/manuel/">Manuel Vivo</a>
                        </span>
                    
                
                <span class="reading-time">
                    
                    
                      1 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

        </div>
    </div>
</aside>

<!-- Floating header which appears on-scroll, included from includes/floating-header.hbs -->
<div class="floating-header">
    <div class="floating-header-logo">
        <a href="https://manuelvivo.dev/">
            
            <span>Manuel Vivo .dev</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">The suspend modifier ‚Äî under the hood</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=The+suspend+modifier+%E2%80%94+under+the+hood&amp;url=https://manuelvivo.dev/suspend-modifier"
            onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https://manuelvivo.dev/suspend-modifier"
            onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>

        </a>
    </div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>


<!-- /post -->

<!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs -->


        <!-- Previous/next page links - displayed on every page -->
        

        <!-- The footer at the very bottom of the screen -->
        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="https://manuelvivo.dev/">Manuel Vivo .dev</a> &copy; 2025</section>
                <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> &
                    <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a> using
                    <a href="https://github.com/jekyller/jasper2" target="_blank" rel="noopener">Jasper2</a></section>
                <nav class="site-footer-nav">
                    <a href="/">Latest Posts</a>
                    
                    <a href="https://twitter.com/manuelvicnt" target="_blank" rel="noopener">Twitter</a>
                    <a href="https://ghost.org" target="_blank" rel="noopener">Ghost</a>
                </nav>
            </div>
        </footer>

    </div>

    <!-- The big email subscribe modal content -->
    

    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.10.0/components/prism-abap.min.js"></script>
    <script>$(document).ready(function() {
      $('pre code').each(function(i, block) {
        hljs.highlightBlock(block);
      });
    });</script>

    <!-- jQuery + Fitvids, which makes all video embeds responsive -->
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://demo.ghost.io/assets/js/jquery.fitvids.js?v=724281a32e"></script>


    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->

    


    <!-- Add Google Analytics  -->
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8WG7TD0NF4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8WG7TD0NF4');
</script>


    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
    
        <script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>

    

    <!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag -->
    <!-- ghost_foot -->

    <!-- Jekyll Ideal Image Slider Include -->
<!-- https://github.com/jekylltools/jekyll-ideal-image-slider-include -->
<!-- v1.8 -->

</body>
</html>

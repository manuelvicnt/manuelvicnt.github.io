<!DOCTYPE html>
<html>
<head>

    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Base Meta -->
    <!-- dynamically fixing the title for tag/author pages -->



    <title>Simplifying APIs with coroutines and Flow</title>

    <!-- This tag outputs SEO meta+structured data and other important settings -->
    <meta name="description" content="A place where you can learn about Android development" />
    <link rel="shortcut icon" href="https://manuelvivo.dev/assets/images/favicon.png" type="image/png" />
    <link rel="canonical" href="https://manuelvivo.dev/simplifying-apis-coroutines" />
    <meta name="referrer" content="no-referrer-when-downgrade" />

     <!--title below is coming from _includes/dynamic_title-->
    <meta property="og:site_name" content="Manuel Vivo .dev" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Simplifying APIs with coroutines and Flow" />
    <meta property="og:description" content="Learn how to create your own coroutine adapters and see how they work under the hood If you‚Äôre a library author, you might want to make your Java-based or callback-based libraries easier to consume from Kotlin using coroutines and Flow. Alternatively, if you‚Äôre an API consumer, you may be willing" />
    <meta property="og:url" content="https://manuelvivo.dev/simplifying-apis-coroutines" />
    <meta property="og:image" content="https://manuelvivo.dev/assets/images/2019-03-24-suspend-modifier.webp" />
    <meta property="article:publisher" content="https://www.facebook.com/" />
    <meta property="article:author" content="https://www.facebook.com/" />
    <meta property="article:published_time" content="2020-12-16T00:00:00+00:00" />
    <meta property="article:modified_time" content="2020-12-16T00:00:00+00:00" />
    <meta property="article:tag" content="Coroutines" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Simplifying APIs with coroutines and Flow" />
    <meta name="twitter:description" content="Learn how to create your own coroutine adapters and see how they work under the hood If you‚Äôre a library author, you might want to make your Java-based or callback-based libraries easier to consume from Kotlin using coroutines and Flow. Alternatively, if you‚Äôre an API consumer, you may be willing" />
    <meta name="twitter:url" content="https://manuelvivo.dev/" />
    <meta name="twitter:image" content="https://manuelvivo.dev/assets/images/2019-03-24-suspend-modifier.webp" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Manuel Vivo .dev" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Coroutines" />
    <meta name="twitter:site" content="@manuelvicnt" />
    <meta name="twitter:creator" content="@manuelvicnt" />
    <meta property="og:image:width" content="1400" />
    <meta property="og:image:height" content="933" />

    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Website",
    "publisher": {
        "@type": "Organization",
        "name": "Manuel Vivo .dev",
        "logo": "https://manuelvivo.dev/"
    },
    "url": "https://manuelvivo.dev/simplifying-apis-coroutines",
    "image": {
        "@type": "ImageObject",
        "url": "https://manuelvivo.dev/assets/images/2019-03-24-suspend-modifier.webp",
        "width": 2000,
        "height": 666
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://manuelvivo.dev/simplifying-apis-coroutines"
    },
    "description": "Learn how to create your own coroutine adapters and see how they work under the hood If you‚Äôre a library author, you might want to make your Java-based or callback-based libraries easier to consume from Kotlin using coroutines and Flow. Alternatively, if you‚Äôre an API consumer, you may be willing"
}
    </script>

<!-- <script type="text/javascript" src="https://demo.ghost.io/public/ghost-sdk.min.js?v=724281a32e"></script>
<script type="text/javascript">
ghost.init({
	clientId: "ghost-frontend",
	clientSecret: "f84a07a72b17"
});
</script> -->

<meta name="generator" content="Jekyll 3.6.2" />
<link rel="alternate" type="application/rss+xml" title="Simplifying APIs with coroutines and Flow" href="/feed.xml" />

<style>
    .highlighter-rouge, .highlight, code {
        width: 100%;
    }
</style>

<!-- Jekyll Ideal Image Slider Include -->
<!-- https://github.com/jekylltools/jekyll-ideal-image-slider-include -->
<!-- v1.8 -->

    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Simplifying APIs with coroutines and Flow | Manuel Vivo .dev</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="Simplifying APIs with coroutines and Flow" />
<meta name="author" content="Manuel Vivo" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Learn how to create your own coroutine adapters and see how they work under the hood" />
<meta property="og:description" content="Learn how to create your own coroutine adapters and see how they work under the hood" />
<link rel="canonical" href="https://manuelvivo.dev/simplifying-apis-coroutines" />
<meta property="og:url" content="https://manuelvivo.dev/simplifying-apis-coroutines" />
<meta property="og:site_name" content="Manuel Vivo .dev" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-12-16T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Simplifying APIs with coroutines and Flow" />
<meta name="twitter:site" content="@" />
<meta name="twitter:creator" content="@manuelvicnt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Manuel Vivo","url":"github.com/manuelvicnt"},"dateModified":"2020-12-16T00:00:00+00:00","datePublished":"2020-12-16T00:00:00+00:00","description":"Learn how to create your own coroutine adapters and see how they work under the hood","headline":"Simplifying APIs with coroutines and Flow","mainEntityOfPage":{"@type":"WebPage","@id":"https://manuelvivo.dev/simplifying-apis-coroutines"},"url":"https://manuelvivo.dev/simplifying-apis-coroutines"}</script>
<!-- End Jekyll SEO tag -->


    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.edited.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/syntax.css" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css?family=Montserrat&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Inter&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro&display=swap" rel="stylesheet">

    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!--[if IE]>
        <style>
            p, ol, ul{
                width: 100%;
            }
            blockquote{
                width: 100%;
            }
        </style>
    <![endif]-->
</head>
<body class="post-template">

    <div class="site-wrapper">
        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left">
        
            
                <a class="site-nav-logo" href="https://manuelvivo.dev/">Manuel Vivo .dev</a>
            
        
        
            <ul class="nav" role="menu">
    <li class="nav-home" role="menuitem"><a href="/">Home</a></li>
    <li class="nav-book" role="menuitem"><a href="https://topmate.io/manuelvivo" target="_blank">üóìÔ∏è Book a 1:1 with me!</a></li>
    <li class="nav-digitalproduct" role="menuitem"><a href="/digitalproduct/">Products</a></li>
    <li class="nav-publicspeaking" role="menuitem"><a href="/publicspeaking/">Public Speaking</a></li>
    <li class="nav-about" role="menuitem"><a href="/about/">About</a></li>
    <li class="nav-gallery" role="menuitem"><a href="/gallery/">Gallery</a></li>
</ul>
        
    </div>
    <div class="site-nav-right">
        <div class="social-links">
            
            
                <a class="social-link social-link-tw" href="https://twitter.com/manuelvicnt" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>
</a>
            
        </div>
        
    </div>
</nav>

    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full  tag-coroutines post ">

            <header class="post-full-header">
              <section class="post-full-meta">
                  <time class="post-full-meta-date" datetime="16 December 2020">16 December 2020</time>
              </section>

              
                  
                    <span class="post-card-tags"><a style="color:white;" href='/tag/coroutines/'>Coroutines</a></span>
                  
              
                <h1 class="post-full-title">Simplifying APIs with coroutines and Flow</h1>
            </header>

            
            <figure class="post-full-image" style="background-image: url(/assets/images/2019-03-24-suspend-modifier.webp)">
            </figure>
            

            <section class="post-full-content">
                <div class="kg-card-markdown">
                    <p>Learn how to create your own coroutine adapters and see how they work under the hood</p>

<p>If you‚Äôre a library author, you might want to make your Java-based or callback-based libraries easier to consume from Kotlin using coroutines and Flow. Alternatively, if you‚Äôre an API consumer, you may be willing to adapt a 3rd party API surface to coroutines to make them more Kotlin friendly.</p>

<p>This article covers how to simplify APIs using coroutines and Flow as well as how to build your own adapter using <code class="language-plaintext highlighter-rouge">suspendCancellableCoroutine</code> and <code class="language-plaintext highlighter-rouge">callbackFlow</code> APIs. For the most curious ones, those APIs will be dissected and you‚Äôll see how they work under the hood.</p>

<p>If you prefer to watch a video about this topic, check this one out:</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/OmHePYcHbyQ" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

<h2 id="check-existing-coroutine-adapters">Check existing coroutine adapters</h2>

<p>Before writing your own wrappers for existing APIs, check if an adapter or <a href="https://medium.com/androiddevelopers/extend-your-code-readability-with-kotlin-extensions-542bf702aa36">extension function</a> is available for your use case. There are existing libraries with coroutine adapters for common types.</p>

<h3 id="future-types">Future types</h3>

<p>For future types, there are integrations for Java 8‚Äôs <a href="https://github.com/Kotlin/kotlinx.coroutines/blob/master/integration/kotlinx-coroutines-jdk8/src/future/Future.kt">CompletableFuture</a>, and Guava‚Äôs <a href="https://github.com/Kotlin/kotlinx.coroutines/blob/master/integration/kotlinx-coroutines-guava/src/ListenableFuture.kt">ListenableFuture</a>. This is not an exhaustive list, search online if an adapter for your future type already exists.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Awaits completion of CompletionStage without blocking a thread</span>
<span class="k">suspend</span> <span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span> <span class="nf">CompletionStage</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;.</span><span class="nf">await</span><span class="p">():</span> <span class="nc">T</span> 

<span class="c1">// Awaits completion of ListenableFuture without blocking a thread</span>
<span class="k">suspend</span> <span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span> <span class="nf">ListenableFuture</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;.</span><span class="nf">await</span><span class="p">():</span> <span class="nc">T</span>
</code></pre></div></div>

<p>With these functions, you can get rid of callbacks and just suspend the coroutine until the future result comes back.</p>

<h3 id="reactive-streams">Reactive Streams</h3>

<p>For reactive stream libraries, there are integrations for <a href="https://github.com/Kotlin/kotlinx.coroutines/tree/master/reactive/kotlinx-coroutines-rx3">RxJava</a>, <a href="https://github.com/Kotlin/kotlinx.coroutines/tree/master/reactive/kotlinx-coroutines-jdk9">Java 9 APIs</a>, and <a href="https://github.com/Kotlin/kotlinx.coroutines/tree/master/reactive/kotlinx-coroutines-reactive">reactive streams</a> libraries.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Transforms the given reactive Publisher into Flow.</span>
<span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span> <span class="p">:</span> <span class="nc">Any</span><span class="p">&gt;</span> <span class="nf">Publisher</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;.</span><span class="nf">asFlow</span><span class="p">():</span> <span class="nc">Flow</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span>
</code></pre></div></div>

<p>These functions convert a reactive stream into Flow.</p>

<h3 id="android-specific-apis">Android specific APIs</h3>

<p>For Jetpack libraries or Android platform APIs, take a look at the <a href="https://developer.android.com/kotlin/ktx/extensions-list">Jetpack KTX libraries list</a>. Currently, more than 20 libraries have a KTX version, creating sweet idiomatic versions of Java APIs, ranging from SharedPreferences to ViewModels, SQLite and even Play Core.</p>

<h3 id="callbacks">Callbacks</h3>

<p>Callbacks are a very common solution for asynchronous communication. In fact, we use them for the Java programming language solution in the <a href="https://developer.android.com/guide/background/threading">Running tasks in background thread guide</a>. However, they come with some drawbacks: this design leads to nested callbacks which ends up in incomprehensible code. Also, error handling is more complicated as there isn‚Äôt an easy way to propagate them.</p>

<p>In Kotlin, you can simplify calling callbacks using coroutines, but for that, you‚Äôll need to build your own adapter.</p>

<h2 id="build-your-own-adapter">Build your own adapter</h2>

<p>If you don‚Äôt find an adapter for your use case, it‚Äôs usually quite straightforward to write your own. <strong>For one-shot async calls, use the <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/suspend-cancellable-coroutine.html"><code class="language-plaintext highlighter-rouge">suspendCancellableCoroutine</code></a> API. For streaming data, use the <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/callback-flow.html"><code class="language-plaintext highlighter-rouge">callbackFlow</code></a> API</strong>.</p>

<p>As an exercise, the following examples will use the <a href="https://developers.google.com/android/reference/com/google/android/gms/location/FusedLocationProviderClient.html">Fused Location Provider</a> API from Google Play Services to get location data. The API surface is simple but it uses callbacks to perform async operations. With coroutines, we can get rid of those callbacks that can quickly make our code unreadable when the logic gets complicated.</p>

<p>In case you want to explore other solutions, you can get inspiration from the source code of all the functions linked above.</p>

<h3 id="one-shot-async-calls">One-shot async calls</h3>

<p>The <a href="https://developers.google.com/android/reference/com/google/android/gms/location/FusedLocationProviderClient.html">Fused Location Provider</a> API provides the <a href="https://developers.google.com/android/reference/com/google/android/gms/location/FusedLocationProviderClient#getLastLocation()"><code class="language-plaintext highlighter-rouge">getLastLocation</code></a> method to obtain the <a href="https://developer.android.com/training/location/retrieve-current">last known location</a>. The ideal API for coroutines is a suspend function that returns exactly that.</p>

<blockquote>
  <p>Note that this API returns a <a href="https://developers.google.com/android/reference/com/google/android/gms/tasks/Task"><code class="language-plaintext highlighter-rouge">Task</code></a> and there‚Äôs already an <a href="https://github.com/Kotlin/kotlinx.coroutines/blob/master/integration/kotlinx-coroutines-play-services/src/Tasks.kt">adapter</a> available for it. However, for learning purposes, we‚Äôll use it as an example.</p>
</blockquote>

<p>We can have a better API by creating an extension function on <code class="language-plaintext highlighter-rouge">FusedLocationProviderClient</code>:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">suspend</span> <span class="k">fun</span> <span class="nc">FusedLocationProviderClient</span><span class="p">.</span><span class="nf">awaitLastLocation</span><span class="p">():</span> <span class="nc">Location</span>
</code></pre></div></div>

<p>As this is a one-shot async operation, we use the <code class="language-plaintext highlighter-rouge">suspendCancellableCoroutine</code> function: a low-level building block for creating suspending functions from the coroutines library.</p>

<p><code class="language-plaintext highlighter-rouge">suspendCancellableCoroutine</code> executes the block of code passed to it as a parameter, then suspends the coroutine execution while waiting for the signal to continue. The coroutine will resume executing when the <code class="language-plaintext highlighter-rouge">resume</code> or <code class="language-plaintext highlighter-rouge">resumeWithException</code> method is called in the coroutine‚Äôs <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.coroutines/-continuation/"><code class="language-plaintext highlighter-rouge">Continuation</code></a> object. For more information about continuations, check out the <em><a href="https://manuelvivo.dev/suspend-modifier">suspend modifier under the hood article</a></em>.</p>

<p>We use the callbacks that can be added to the <code class="language-plaintext highlighter-rouge">getLastLocation</code> method to resume the coroutine appropriately. See the implementation below:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Extension function on FusedLocationProviderClient, returns last known location</span>
<span class="k">suspend</span> <span class="k">fun</span> <span class="nc">FusedLocationProviderClient</span><span class="p">.</span><span class="nf">awaitLastLocation</span><span class="p">():</span> <span class="nc">Location</span> <span class="p">=</span>

  <span class="c1">// Create a new coroutine that can be cancelled</span>
  <span class="n">suspendCancellableCoroutine</span><span class="p">&lt;</span><span class="nc">Location</span><span class="p">&gt;</span> <span class="p">{</span> <span class="n">continuation</span> <span class="p">-&gt;</span>

    <span class="c1">// Add listeners that will resume the execution of this coroutine</span>
    <span class="n">lastLocation</span><span class="p">.</span><span class="nf">addOnSuccessListener</span> <span class="p">{</span> <span class="n">location</span> <span class="p">-&gt;</span>
      <span class="c1">// Resume coroutine and return location</span>
      <span class="n">continuation</span><span class="p">.</span><span class="nf">resume</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
    <span class="p">}.</span><span class="nf">addOnFailureListener</span> <span class="p">{</span> <span class="n">e</span> <span class="p">-&gt;</span>
      <span class="c1">// Resume the coroutine by throwing an exception</span>
      <span class="n">continuation</span><span class="p">.</span><span class="nf">resumeWithException</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// End of the suspendCancellableCoroutine block. This suspends the</span>
    <span class="c1">// coroutine until one of the callbacks calls the continuation parameter.</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>Note: Although you will also find a non-cancellable version of this coroutine builder in the coroutines library (i.e. <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.coroutines/suspend-coroutine.html"><code class="language-plaintext highlighter-rouge">suspendCoroutine</code></a>), it is preferable to always choose <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/suspend-cancellable-coroutine.html"><code class="language-plaintext highlighter-rouge">suspendCancellableCoroutine</code></a> to handle cancellation of the coroutine scope, or to propagate cancellation from the underlying API.</p>

<h4 id="suspendcancellablecoroutine-under-the-hood">suspendCancellableCoroutine under the hood</h4>

<p>Internally, <a href="https://github.com/Kotlin/kotlinx.coroutines/blob/master/kotlinx-coroutines-core/common/src/CancellableContinuation.kt#L305"><code class="language-plaintext highlighter-rouge">suspendCancellableCoroutine</code></a> uses <a href="https://github.com/JetBrains/kotlin/blob/master/libraries/stdlib/src/kotlin/coroutines/intrinsics/Intrinsics.kt#L41"><code class="language-plaintext highlighter-rouge">suspendCoroutineUninterceptedOrReturn</code></a> to get the <code class="language-plaintext highlighter-rouge">Continuation</code> of the coroutine inside a suspend function. That <code class="language-plaintext highlighter-rouge">Continuation</code> object is intercepted by a <a href="https://github.com/Kotlin/kotlinx.coroutines/blob/master/kotlinx-coroutines-core/common/src/CancellableContinuation.kt"><code class="language-plaintext highlighter-rouge">CancellableContinuation</code></a> that will control the lifecycle of that coroutine from that point (its <a href="https://github.com/Kotlin/kotlinx.coroutines/blob/master/kotlinx-coroutines-core/common/src/CancellableContinuationImpl.kt">implementation</a> has the functionality of a <code class="language-plaintext highlighter-rouge">Job</code> with some restrictions).</p>

<p>After that, the lambda passed to <code class="language-plaintext highlighter-rouge">suspendCancellableCoroutine</code> will be executed and the coroutine will either resume immediately if the lambda returns a result or will be suspended until the <code class="language-plaintext highlighter-rouge">CancellableContinuation</code> is resumed manually from the lambda.</p>

<p>See my own comments in the following code snippet (following the <a href="https://github.com/Kotlin/kotlinx.coroutines/blob/master/kotlinx-coroutines-core/common/src/CancellableContinuation.kt#L305">original implementation</a>) to understand what‚Äôs happening:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">suspend</span> <span class="k">inline</span> <span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span> <span class="nf">suspendCancellableCoroutine</span><span class="p">(</span>
  <span class="k">crossinline</span> <span class="n">block</span><span class="p">:</span> <span class="p">(</span><span class="nc">CancellableContinuation</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;)</span> <span class="p">-&gt;</span> <span class="nc">Unit</span>
<span class="p">):</span> <span class="nc">T</span> <span class="p">=</span>
  <span class="c1">// Get the Continuation object of the coroutine that it's running this suspend function</span>
  <span class="nf">suspendCoroutineUninterceptedOrReturn</span> <span class="p">{</span> <span class="n">uCont</span> <span class="p">-&gt;</span>

    <span class="c1">// Take over the control of the coroutine. The Continuation's been</span>
    <span class="c1">// intercepted and it follows the CancellableContinuationImpl lifecycle now</span>
    <span class="kd">val</span> <span class="py">cancellable</span> <span class="p">=</span> <span class="nc">CancellableContinuationImpl</span><span class="p">(</span><span class="n">uCont</span><span class="p">.</span><span class="nf">intercepted</span><span class="p">(),</span> <span class="cm">/* ... */</span><span class="p">)</span>
    <span class="cm">/* ... */</span>
 
    <span class="c1">// Call block of code with the cancellable continuation</span>
    <span class="nf">block</span><span class="p">(</span><span class="n">cancellable</span><span class="p">)</span>
        
    <span class="c1">// Either suspend the coroutine and wait for the Continuation to be resumed</span>
    <span class="c1">// manually in `block` or return a result if `block` has finished executing</span>
    <span class="n">cancellable</span><span class="p">.</span><span class="nf">getResult</span><span class="p">()</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>To know more about how suspend functions work under the hood, check out the <em><a href="https://manuelvivo.dev/suspend-modifier">suspend modifier under the hood article</a></em>.</p>

<h3 id="streaming-data">Streaming data</h3>

<p>If instead we wanted to receive periodic location updates (using the <a href="https://developers.google.com/android/reference/com/google/android/gms/location/FusedLocationProviderClient#requestLocationUpdates(com.google.android.gms.location.LocationRequest,%20com.google.android.gms.location.LocationCallback,%20android.os.Looper)"><code class="language-plaintext highlighter-rouge">requestLocationUpdates</code></a> function) whenever the user‚Äôs device moves in the real world, we‚Äôd need to create a stream of data using <a href="https://kotlinlang.org/docs/reference/coroutines/flow.html">Flow</a>. The ideal API would look like this:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nc">FusedLocationProviderClient</span><span class="p">.</span><span class="nf">locationFlow</span><span class="p">():</span> <span class="nc">Flow</span><span class="p">&lt;</span><span class="nc">Location</span><span class="p">&gt;</span>
</code></pre></div></div>

<p>To convert streaming callback-based APIs to Flow, use the <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/callback-flow.html"><code class="language-plaintext highlighter-rouge">callbackFlow</code></a> flow builder that creates a new flow. In the <code class="language-plaintext highlighter-rouge">callbackFlow</code> lambda, we‚Äôre in the context of a coroutine, therefore, suspend functions can be called. Unlike the <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/flow.html"><code class="language-plaintext highlighter-rouge">flow</code></a> flow builder, <code class="language-plaintext highlighter-rouge">channelFlow</code> allows values to be emitted from a different <code class="language-plaintext highlighter-rouge">CoroutineContext</code> or outside a coroutine, with the <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.channels/-send-channel/offer.html"><code class="language-plaintext highlighter-rouge">offer</code></a> method.</p>

<p>Normally, flow adapters using <code class="language-plaintext highlighter-rouge">callbackFlow</code> follow these three generic steps:</p>

<ol>
  <li>Create the callback that adds elements into the flow using <code class="language-plaintext highlighter-rouge">offer</code>.</li>
  <li>Register the callback.</li>
  <li>Wait for the consumer to cancel the coroutine and unregister the callback.</li>
</ol>

<p>Applying this recipe to this use case, we get the following implementation:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Send location updates to the consumer </span>
<span class="k">fun</span> <span class="nc">FusedLocationProviderClient</span><span class="p">.</span><span class="nf">locationFlow</span><span class="p">()</span> <span class="p">=</span> <span class="n">callbackFlow</span><span class="p">&lt;</span><span class="nc">Location</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="c1">// A new Flow is created. This code executes in a coroutine!</span>

  <span class="c1">// 1. Create callback and add elements into the flow</span>
  <span class="kd">val</span> <span class="py">callback</span> <span class="p">=</span> <span class="kd">object</span> <span class="err">: </span><span class="nc">LocationCallback</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onLocationResult</span><span class="p">(</span><span class="n">result</span><span class="p">:</span> <span class="nc">LocationResult</span><span class="p">?)</span> <span class="p">{</span>
      <span class="n">result</span> <span class="o">?:</span> <span class="k">return</span> <span class="c1">// Ignore null responses</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">location</span> <span class="k">in</span> <span class="n">result</span><span class="p">.</span><span class="n">locations</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="nf">offer</span><span class="p">(</span><span class="n">location</span><span class="p">)</span> <span class="c1">// Send location to the flow</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="nc">Throwable</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// Location couldn't be sent to the flow </span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// 2. Register the callback to get location updates by calling requestLocationUpdates</span>
  <span class="nf">requestLocationUpdates</span><span class="p">(</span>
    <span class="nf">createLocationRequest</span><span class="p">(),</span>
    <span class="n">callback</span><span class="p">,</span>
    <span class="nc">Looper</span><span class="p">.</span><span class="nf">getMainLooper</span><span class="p">()</span>
  <span class="p">).</span><span class="nf">addOnFailureListener</span> <span class="p">{</span> <span class="n">e</span> <span class="p">-&gt;</span>
    <span class="nf">close</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="c1">// in case of error, close the Flow</span>
  <span class="p">}</span>

  <span class="c1">// 3. Wait for the consumer to cancel the coroutine and unregister</span>
  <span class="c1">// the callback. This suspends the coroutine until the Flow is closed.</span>
  <span class="nf">awaitClose</span> <span class="p">{</span>
    <span class="c1">// Clean up code goes here</span>
    <span class="nf">removeLocationUpdates</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="callbackflow-under-the-hood">callbackFlow under the hood</h4>

<p>Internally, <code class="language-plaintext highlighter-rouge">callbackFlow</code> uses a <a href="https://kotlinlang.org/docs/reference/coroutines/channels.html">channel</a>, which is conceptually very similar to a blocking <a href="https://en.wikipedia.org/wiki/Queue_(abstract_data_type)">queue</a>. A channel is configured with a <code class="language-plaintext highlighter-rouge">capacity</code>: the number of elements that can be buffered. The channel created in <code class="language-plaintext highlighter-rouge">callbackFlow</code> has the default capacity of 64 elements. When adding a new element to an already full channel, <code class="language-plaintext highlighter-rouge">send</code> will suspend the producer until there‚Äôs space for the new element in the channel whereas <code class="language-plaintext highlighter-rouge">offer</code> won‚Äôt add the element to the channel and will return <code class="language-plaintext highlighter-rouge">false</code> immediately.</p>

<h4 id="awaitclose-under-the-hood">awaitClose under the hood</h4>

<p>Interestingly, <code class="language-plaintext highlighter-rouge">awaitClose</code> uses <code class="language-plaintext highlighter-rouge">suspendCancellableCoroutine</code> under the hood. See my own comments in the following code snippet (following the <a href="https://github.com/Kotlin/kotlinx.coroutines/blob/master/kotlinx-coroutines-core/common/src/channels/Produce.kt#L49">original implementation</a>) to understand what‚Äôs happening:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">ProducerScope</span><span class="p">&lt;*&gt;.</span><span class="nf">awaitClose</span><span class="p">(</span><span class="n">block</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="nc">Unit</span> <span class="p">=</span> <span class="p">{})</span> <span class="p">{</span>
  <span class="cm">/* ... */</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="c1">// Suspend the coroutine with a cancellable continuation</span>
    <span class="n">suspendCancellableCoroutine</span><span class="p">&lt;</span><span class="nc">Unit</span><span class="p">&gt;</span> <span class="p">{</span> <span class="n">cont</span> <span class="p">-&gt;</span>
      <span class="c1">// Suspend forever and resume the coroutine successfully only </span>
      <span class="c1">// when the Flow/Channel is closed</span>
      <span class="nf">invokeOnClose</span> <span class="p">{</span> <span class="n">cont</span><span class="p">.</span><span class="nf">resume</span><span class="p">(</span><span class="nc">Unit</span><span class="p">)</span> <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
    <span class="c1">// Always execute caller's clean up code</span>
    <span class="nf">block</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="reusing-the-flow">Reusing the Flow</h4>

<p>Flows are cold and lazy unless specified otherwise with intermediate operators such as <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/conflate.html"><code class="language-plaintext highlighter-rouge">conflate</code></a>. This means that the builder block will be executed each time a terminal operator is called on the flow. This might not be a huge problem in our case as adding new location listeners is cheap, however, it might make a difference in other implementations.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">FusedLocationProviderClient</span><span class="p">.</span><span class="nf">locationFlow</span><span class="p">()</span> <span class="p">=</span> <span class="n">callbackFlow</span><span class="p">&lt;</span><span class="nc">Location</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="cm">/* ... */</span>
<span class="p">}.</span><span class="nf">shareIn</span><span class="p">(</span>
  <span class="c1">// Make the flow follow the applicationScope</span>
  <span class="n">applicationScope</span><span class="p">,</span>
  <span class="c1">// Emit the last emitted element to new collectors</span>
  <span class="n">replay</span> <span class="p">=</span> <span class="mi">1</span><span class="p">,</span>
  <span class="c1">// Keep the producer active while there are active subscribers</span>
  <span class="n">started</span> <span class="p">=</span> <span class="nc">SharingStarted</span><span class="p">.</span><span class="nc">WhileSubscribed</span><span class="p">()</span>
<span class="p">)</span>
</code></pre></div></div>

<p>To learn more about best practices for adding an <code class="language-plaintext highlighter-rouge">applicationScope</code> to your app, check out this <a href="https://manuelvivo.dev/coroutines-cancellation-exceptions-4">article</a>.</p>

<hr />

<p>Consider creating coroutine adapters to make your APIs or existing APIs concise, readable and Kotlin idiomatic. First check if the adapter is already available and if not, create your own using <code class="language-plaintext highlighter-rouge">suspendCancellableCoroutine</code> for one-shot calls and <code class="language-plaintext highlighter-rouge">callbackFlow</code> for streaming data.</p>

<p>To get hands-on this topic, check out the <a href="https://codelabs.developers.google.com/codelabs/building-kotlin-extensions-library"><em>Building a Kotlin extensions library</em> codelab</a>.</p>


                </div>
            </section>

            <!-- Email subscribe form at the bottom of the page -->
            

            <footer class="post-full-footer">
                <!-- Everything inside the #author tags pulls data from the author -->
                <!-- #author-->
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                        <section class="author-card">
                            
                                <img class="author-profile-image" src="/assets/images/manuelvicnt.jpg" alt="manuel" />
                            
                            <section class="author-card-content">
                                <h4 class="author-card-name"><a href="/author/manuel">Manuel Vivo</a></h4>
                                
                                    <p>Android Developer Relations @ Google</p>
                                
                            </section>
                        </section>
                        <div class="post-full-footer-right">
                            <a class="author-card-button" href="/author/manuel">Read More</a>
                        </div>
                    
                
                <!-- /author  -->
            </footer>

            <!-- If you use Disqus comments, just uncomment this block.
            The only thing you need to change is "test-apkdzgmqhj" - which
            should be replaced with your own Disqus site-id. -->
            
                <section class="post-full-comments">
                    <div id="disqus_thread"></div>
                    <script>
                        var disqus_config = function () {
                            this.page.url = 'https://manuelvivo.dev/simplifying-apis-coroutines';
                            this.page.identifier = '/simplifying-apis-coroutines';
                            this.page.title = 'Simplifying APIs with coroutines and Flow';
                        };
                        (function() {
                            var d = document, s = d.createElement('script');
                            s.src = 'https://manuelvivo.disqus.com/embed.js';
                            s.setAttribute('data-timestamp', +new Date());
                            (d.head || d.body).appendChild(s);
                        })();
                    </script>
                </section>
            

        </article>

    </div>
</main>

<!-- Links to Previous/Next posts -->
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            
                
                
                
                
                    <article class="read-next-card"
                        
                            style="background-image: url(/assets/images/blog-cover.jpg)"
                        
                    >
                        <header class="read-next-card-header">
                            <small class="read-next-card-header-sitetitle">&mdash; Manuel Vivo .dev &mdash;</small>
                            
                                <h3 class="read-next-card-header-title"><a href="/tag/coroutines/">Coroutines</a></h3>
                            
                        </header>
                        <div class="read-next-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
</div>
                        <div class="read-next-card-content">
                            <ul>
                                
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/kotlin-flows-in-practice">Kotlin Flows in practice</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/repeatonlifecycle">repeatOnLifecycle API design story</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/coroutinescope-hilt">Create an application CoroutineScope using Hilt</a></li>
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                            </ul>
                        </div>
                        <footer class="read-next-card-footer">
                            <a href="/tag/coroutines/">
                                
                                    See all 18 posts  ‚Üí
                                
                            </a>
                        </footer>
                    </article>
                
            

            <!-- If there's a next post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/viewmodelcomponent">
                <div class="post-card-image" style="background-image: url(/assets/images/2021-01-21-viewmodelcomponent.png)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/viewmodelcomponent">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Hilt</span>
                            
                        
                    

                    <h2 class="post-card-title">Using Hilt's ViewModelComponent</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p></p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                        
                        <img class="author-profile-image" src="/assets/images/manuelvicnt.jpg" alt="Manuel Vivo" />
                        
                        <span class="post-card-author">
                            <a href="/author/manuel/">Manuel Vivo</a>
                        </span>
                    
                
                <span class="reading-time">
                    
                    
                      1 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

            <!-- If there's a previous post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/migrating-to-Hilt">
                <div class="post-card-image" style="background-image: url(/assets/images/2020-11-24-migrating-to-Hilt.png)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/migrating-to-Hilt">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Hilt</span>
                            
                        
                    

                    <h2 class="post-card-title">Migrating from Dagger to Hilt ‚Äî Is it worth it?</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p></p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                        
                        <img class="author-profile-image" src="/assets/images/manuelvicnt.jpg" alt="Manuel Vivo" />
                        
                        <span class="post-card-author">
                            <a href="/author/manuel/">Manuel Vivo</a>
                        </span>
                    
                
                <span class="reading-time">
                    
                    
                      1 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

        </div>
    </div>
</aside>

<!-- Floating header which appears on-scroll, included from includes/floating-header.hbs -->
<div class="floating-header">
    <div class="floating-header-logo">
        <a href="https://manuelvivo.dev/">
            
            <span>Manuel Vivo .dev</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">Simplifying APIs with coroutines and Flow</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=Simplifying+APIs+with+coroutines+and+Flow&amp;url=https://manuelvivo.dev/simplifying-apis-coroutines"
            onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https://manuelvivo.dev/simplifying-apis-coroutines"
            onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>

        </a>
    </div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>


<!-- /post -->

<!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs -->


        <!-- Previous/next page links - displayed on every page -->
        

        <!-- The footer at the very bottom of the screen -->
        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="https://manuelvivo.dev/">Manuel Vivo .dev</a> &copy; 2025</section>
                <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> &
                    <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a> using
                    <a href="https://github.com/jekyller/jasper2" target="_blank" rel="noopener">Jasper2</a></section>
                <nav class="site-footer-nav">
                    <a href="/">Latest Posts</a>
                    
                    <a href="https://twitter.com/manuelvicnt" target="_blank" rel="noopener">Twitter</a>
                    <a href="https://ghost.org" target="_blank" rel="noopener">Ghost</a>
                </nav>
            </div>
        </footer>

    </div>

    <!-- The big email subscribe modal content -->
    

    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.10.0/components/prism-abap.min.js"></script>
    <script>$(document).ready(function() {
      $('pre code').each(function(i, block) {
        hljs.highlightBlock(block);
      });
    });</script>

    <!-- jQuery + Fitvids, which makes all video embeds responsive -->
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://demo.ghost.io/assets/js/jquery.fitvids.js?v=724281a32e"></script>


    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->

    


    <!-- Add Google Analytics  -->
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8WG7TD0NF4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8WG7TD0NF4');
</script>


    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
    
        <script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>

    

    <!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag -->
    <!-- ghost_foot -->

    <!-- Jekyll Ideal Image Slider Include -->
<!-- https://github.com/jekylltools/jekyll-ideal-image-slider-include -->
<!-- v1.8 -->

</body>
</html>
